import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  onSnapshot, 
  deleteDoc, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  Twitter, Mail, Palette, Plus, Trash2, 
  ChevronDown, Check, ShieldCheck,
  Camera, Info, Lock, X, Send, Home,
  Menu as MenuIcon, User as UserIcon, Image as ImageIcon
} from 'lucide-react';

// --- Firebase Configuration ---
// ç’°å¢ƒå¤‰æ•° __firebase_config ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'medaka-aqua-v5';

// èƒŒæ™¯ã®æ³¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
const Bubbles = () => (
  <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
    {[...Array(10)].map((_, i) => (
      <div 
        key={i}
        className="absolute bg-white/30 rounded-full animate-bubble"
        style={{
          width: `${Math.random() * 15 + 5}px`,
          height: `${Math.random() * 15 + 5}px`,
          left: `${Math.random() * 100}%`,
          bottom: '-20px',
          animationDuration: `${Math.random() * 4 + 4}s`,
          animationDelay: `${Math.random() * 5}s`
        }}
      />
    ))}
    <style>{`
      @keyframes bubble {
        0% { transform: translateY(0) scale(1); opacity: 0; }
        20% { opacity: 0.4; }
        100% { transform: translateY(-100vh) scale(1.2); opacity: 0; }
      }
      .animate-bubble { animation: bubble linear infinite; }
    `}</style>
  </div>
);

const App = () => {
  const [currentPage, setCurrentPage] = useState('home');
  const [user, setUser] = useState(null);
  const [portfolio, setPortfolio] = useState([]);
  const [openMenuId, setOpenMenuId] = useState(null);
  const [isAdminOpen, setIsAdminOpen] = useState(false);
  const [isAuth, setIsAuth] = useState(false);
  const [adminPass, setAdminPass] = useState("");
  const [newPost, setNewPost] = useState({ title: '', url: '', category: 'Illustration' });
  const [loading, setLoading] = useState(true);

  // èªè¨¼ã®åˆæœŸåŒ– (Rule 3 éµå®ˆ)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Auth failed:", e);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // ãƒ‡ãƒ¼ã‚¿å–å¾— (Rule 1 & 2 éµå®ˆ)
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'works');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      setPortfolio(items.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    }, (error) => {
      console.error("Firestore error:", error);
    });
    return () => unsubscribe();
  }, [user]);

  const addWork = async () => {
    if (!newPost.title || !newPost.url || !user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'works'), {
        ...newPost,
        createdAt: serverTimestamp(),
        userId: user.uid
      });
      setNewPost({ title: '', url: '', category: 'Illustration' });
      alert("æ°´æ§½ã«ä½œå“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼");
    } catch (e) {
      console.error("Add failed:", e);
    }
  };

  const deleteWork = async (id) => {
    if (!user) return;
    if (confirm("ã“ã®ä½œå“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'works', id));
    }
  };

  const categories = [
    {
      id: 'standing', name: 'å…¨èº«ç«‹ã¡çµµ', icon: 'ğŸ‘¤', old: '12,000', price: '8,000',
      desc: 'é…ä¿¡ã‚„ã‚¢ã‚¯ã‚¹ã‚¿åŒ–ã«æœ€é©ãªå…¨èº«é€éã‚¤ãƒ©ã‚¹ãƒˆã€‚',
      details: { spec: "A4(350dpi) / é€éPNG", flow: "ãƒ©ãƒ•(2å›ç„¡æ–™) â†’ æ¸…æ›¸", point: "ç­‰èº«å¤§ãƒ‘ãƒãƒ«ã«ã‚‚è€ãˆã‚‹é«˜è§£åƒåº¦ã€‚Live2Dç”¨ãƒ‘ãƒ¼ãƒ„åˆ†ã‘ç›¸è«‡å¯ã€‚" },
      options: [{ name: "è¡¨æƒ…å·®åˆ†(1ç¨®)", price: "+Â¥1,000" }, { name: "ç›®ãƒ‘ãƒãƒ»å£ãƒ‘ã‚¯ãƒ‘ãƒ¼ãƒ„åˆ†ã‘", price: "+Â¥3,000" }]
    },
    {
      id: 'mv', name: 'MVãƒ»å‹•ç”»ç”¨ç‰¹åŒ–', icon: 'ğŸ¥', old: '10,000', price: '7,000',
      desc: 'æ—¢å­˜MVã¸ã®çµµæŸ„å¯„ã›ã€å¡—ã‚Šè¶³ã—å‡¦ç†å®Œå‚™ã€‚',
      details: { spec: "1920x1080ä»¥ä¸Š / PNG", flow: "æ¥½æ›²ç›¸è«‡ â†’ ãƒ©ãƒ• â†’ ä»•ä¸Šã’", point: "å‹•ã‹ã—ãŸæ™‚ã«ç«¯ãŒåˆ‡ã‚Œãªã„å®Ÿç”¨çš„ãªãƒ‡ãƒ¼ã‚¿åˆ¶ä½œã€‚" },
      options: [{ name: "ãƒãƒ¼ã‚ºå·®åˆ†è¿½åŠ ", price: "+Â¥3,000ã€œ" }]
    },
    {
      id: 'scene', name: 'ä¸€æšçµµ(èƒŒæ™¯è¾¼)', icon: 'ğŸŒŠ', old: '15,000', price: '10,000',
      desc: 'å…‰ã¨æ°´ã®æ¼”å‡ºã‚’é‡è¦–ã€‚ç‰©èªã‚’æ„Ÿã˜ã‚‹1æšã€‚',
      details: { spec: "æŒ‡å®šã‚µã‚¤ã‚º / PNG", flow: "ç›¸è«‡ â†’ ãƒ©ãƒ• â†’ ä»•ä¸Šã’", point: "ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãªãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°æ¼”å‡ºãŒå¾—æ„ã§ã™ã€‚" },
      options: [{ name: "äººç‰©è¿½åŠ ", price: "+Â¥7,000" }]
    },
    {
      id: 'sd', name: 'SDã‚­ãƒ£ãƒ©', icon: 'âœ¨', old: '5,000', price: '4,000',
      desc: 'ã‚¹ã‚¿ãƒ³ãƒ—ã€ã‚°ãƒƒã‚ºã«æœ€é©ãªã¡ã³ã‚­ãƒ£ãƒ©ã€‚',
      details: { spec: "2000pxæ­£æ–¹å½¢ / é€éPNG", flow: "ãƒãƒ¼ã‚ºç›¸è«‡ â†’ æ¸…æ›¸", point: "å‹•ç”»å†…ã§æ˜ ãˆã‚‹è¦–èªæ€§ã®è‰¯ã„ã‹ã‚ã„ã‚‰ã—ã„ãƒ•ã‚©ãƒ«ãƒ ã€‚" },
      options: [{ name: "è¡¨æƒ…ãƒ‘ãƒƒã‚¯(5ç¨®)", price: "+Â¥2,500" }]
    }
  ];

  const renderContent = () => {
    switch(currentPage) {
      case 'profile':
        return (
          <div className="pt-20 pb-32 max-w-2xl mx-auto px-6 animate-in fade-in slide-in-from-bottom-4">
            <h2 className="text-3xl font-black text-cyan-700 mb-8 flex items-center gap-3">Profile</h2>
            <div className="bg-white rounded-[3rem] p-10 shadow-sm border border-blue-50 space-y-8 text-sm">
              <section>
                <h3 className="font-black text-blue-900 mb-2">ã‚ã ã‹ / Medaka</h3>
                <p>ã‚²ãƒ¼ãƒ å®Ÿæ³ï¼ˆè˜­ãŸã‚“æ§˜ï¼‰ã‚’ç³§ã«æãçµµæãã€‚Webtoonç€å½©çµŒé¨“ã‚’æ´»ã‹ã—ãŸè‰²å½©ãŒæ­¦å™¨ã€‚ClipStudio EX / PS / AIä½¿ç”¨ã€‚</p>
              </section>
              <div className="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                <p className="font-bold mb-1">ç¾åœ¨ã®æŒ‘æˆ¦</p>
                <p className="text-xs">Live2Dãƒ‘ãƒ¼ãƒ„åˆ†ã‘ã€æ¨ªèª­ã¿æ¼«ç”»ã€ãƒãƒ¼ãƒ ç‰¹è¨“ä¸­ã€‚ã©ã‚“ãªä¾é ¼ã‚‚ã€Œæ°´ã€ã®ã‚ˆã†ã«æŸ”è»Ÿã«å¯¾å¿œã—ã¾ã™ã€‚</p>
              </div>
            </div>
          </div>
        );
      case 'portfolio':
        return (
          <div className="pt-20 pb-32 max-w-5xl mx-auto px-6 animate-in fade-in slide-in-from-bottom-4">
            <h2 className="text-3xl font-black text-cyan-700 mb-8 flex items-center gap-3">Gallery</h2>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              {portfolio.length === 0 ? (
                <div className="col-span-full py-20 text-center text-slate-300 italic">ä½œå“ã‚’æº–å‚™ä¸­ã§ã™...</div>
              ) : (
                portfolio.map(work => (
                  <div key={work.id} className="group relative aspect-[4/5] bg-white rounded-3xl overflow-hidden shadow-sm border border-white hover:scale-[1.02] transition-all">
                    <img src={work.url} alt={work.title} className="w-full h-full object-cover" />
                    <div className="absolute inset-0 bg-gradient-to-t from-cyan-900/60 to-transparent opacity-0 group-hover:opacity-100 transition-all p-4 flex flex-col justify-end text-white font-bold text-xs">
                      {work.title}
                      {isAuth && <button onClick={() => deleteWork(work.id)} className="absolute top-2 right-2 p-1 bg-red-500 rounded hover:bg-red-600 shadow-lg"><Trash2 className="w-4 h-4" /></button>}
                    </div>
                  </div>
                ))
              )}
            </div>
            <div className="mt-8 text-center"><button onClick={() => setIsAdminOpen(true)} className="text-[10px] text-slate-300 hover:text-slate-500 transition-colors">Admin Login</button></div>
          </div>
        );
      case 'menu':
        return (
          <div className="pt-20 pb-32 max-w-2xl mx-auto px-6 animate-in fade-in slide-in-from-bottom-4">
            <h2 className="text-3xl font-black text-cyan-700 mb-8 flex items-center gap-3">Order Menu</h2>
            <div className="bg-red-500 text-white px-4 py-1.5 rounded-full text-[10px] font-black inline-block mb-8 animate-pulse shadow-lg">å®Ÿç¸¾å…¬é–‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸­ï¼šå„ å…ˆç€5åæ§˜</div>
            <div className="space-y-4">
              {categories.map(c => (
                <div key={c.id} className={`bg-white rounded-[2rem] border transition-all duration-300 ${openMenuId === c.id ? 'border-cyan-400 ring-4 ring-cyan-100' : 'border-slate-100 shadow-sm'}`}>
                  <div className="p-6 flex justify-between items-center cursor-pointer" onClick={() => setOpenMenuId(openMenuId === c.id ? null : c.id)}>
                    <div className="flex items-center gap-4">
                      <span className="text-2xl">{c.icon}</span>
                      <h3 className="font-bold text-slate-700">{c.name}</h3>
                    </div>
                    <div className="text-right">
                       <div className="text-[10px] text-slate-400 line-through italic">Â¥{c.old}ã€œ</div>
                       <div className="text-xl font-black text-cyan-600">Â¥{c.price}ã€œ</div>
                    </div>
                  </div>
                  {openMenuId === c.id && (
                    <div className="px-8 pb-8 pt-4 border-t border-slate-50 bg-cyan-50/10 space-y-6">
                       <p className="text-xs text-slate-500">{c.desc}</p>
                       <div className="grid md:grid-cols-2 gap-4">
                          <div className="bg-white p-4 rounded-xl shadow-sm text-[11px] border border-cyan-50">
                            <h4 className="font-black text-cyan-400 mb-1 flex items-center gap-1"><Check className="w-3 h-3" /> ä»•æ§˜</h4>
                            <p>{c.details.spec}</p>
                          </div>
                          <div className="bg-cyan-600 text-white p-4 rounded-xl shadow-md text-[11px]">
                            <h4 className="font-black text-cyan-100 mb-1">ã‚ã ã‹ã®ã“ã ã‚ã‚Š</h4>
                            <p>{c.details.point}</p>
                          </div>
                       </div>
                       <div className="space-y-1">
                          {c.options.map((opt, i) => (
                            <div key={i} className="flex justify-between bg-white px-4 py-2 rounded-lg text-xs border border-slate-100">
                               <span>{opt.name}</span><span className="font-black text-cyan-600">{opt.price}</span>
                            </div>
                          ))}
                       </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
            
            <div className="mt-12 bg-slate-900 text-white rounded-[3rem] p-10 shadow-2xl relative overflow-hidden">
               <div className="absolute top-0 right-0 w-64 h-64 bg-cyan-500/20 blur-[100px] -mr-32 -mt-32"></div>
               <h3 className="text-xl font-black mb-8 flex items-center gap-3">
                  <ShieldCheck className="w-6 h-6 text-emerald-400" /> GUIDELINES
               </h3>
               <div className="grid md:grid-cols-2 gap-8 text-[11px] text-slate-400 leading-relaxed">
                  <div className="space-y-4">
                     <p className="font-bold text-white border-b border-white/10 pb-1">å•†ç”¨åˆ©ç”¨</p>
                     <p>åˆ¶ä½œè²»ã® +50% ã‚’é ‚æˆ´ã—ã¾ã™ã€‚(åç›ŠåŒ–é…ä¿¡ãƒ»ã‚°ãƒƒã‚ºãƒ»æœ‰å„Ÿã‚¤ãƒ™ãƒ³ãƒˆåˆ©ç”¨ç­‰)</p>
                     <p className="font-bold text-white border-b border-white/10 pb-1">è‘—ä½œæ¨©ãƒ»å®Ÿç¸¾å…¬é–‹</p>
                     <p>è­²æ¸¡ãªã—ã€‚è‡ªä½œç™ºè¨€ãƒ»AIå­¦ç¿’ç¦æ­¢ã€‚å®Ÿç¸¾éå…¬é–‹å¸Œæœ›ã¯åˆ¶ä½œè²»ã®+50%ã‚’é ‚æˆ´ã—ã¾ã™ã€‚</p>
                  </div>
                  <div className="space-y-4">
                     <p className="font-bold text-white border-b border-white/10 pb-1">ãƒªãƒ†ã‚¤ã‚¯ãƒ»ç´æœŸ</p>
                     <p>ãƒ©ãƒ•2å›ã¾ã§ç„¡æ–™ã€‚æ¸…æ›¸å¾Œã®ä¿®æ­£ã¯è¿½åŠ æ–™é‡‘ã€‚é€šå¸¸2é€±é–“ã€œ1ãƒ¶æœˆç¨‹åº¦ã®ç´æœŸã‚’é ‚ãã¾ã™ã€‚</p>
                  </div>
               </div>
            </div>
          </div>
        );
      case 'contact':
        return (
          <div className="pt-20 pb-32 max-w-xl mx-auto px-6 text-center animate-in fade-in slide-in-from-bottom-4">
            <h2 className="text-3xl font-black text-cyan-700 mb-12 flex items-center gap-3 justify-center">Contact</h2>
            <div className="bg-white rounded-[3.5rem] p-12 shadow-xl border border-blue-50">
               <h3 className="font-black mb-10 text-slate-700">ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ï¼</h3>
               <div className="space-y-4">
                  <a href="https://twitter.com/medapappa" target="_blank" rel="noreferrer" className="w-full bg-[#1DA1F2] text-white py-5 rounded-3xl font-black flex items-center justify-center gap-3 no-underline shadow-lg hover:scale-105 transition-transform">
                    <Twitter className="w-5 h-5" /> X(Twitter) DM
                  </a>
                  <p className="text-xs text-slate-400 pt-4 font-bold">medapappa@gmail.com</p>
               </div>
            </div>
          </div>
        );
      default:
        return (
          <div className="min-h-screen flex flex-col items-center justify-center relative bg-gradient-to-b from-blue-300 to-cyan-100 overflow-hidden">
            <Bubbles />
            <div className="relative z-10 text-center px-6">
              <div className="w-24 h-24 bg-white rounded-full flex items-center justify-center text-4xl shadow-xl mx-auto mb-8 border-4 border-white/50 animate-pulse">ğŸŸ</div>
              <h1 className="text-5xl font-black text-white tracking-tighter mb-4 italic drop-shadow-md">MEDAKA AQUARIUM</h1>
              <p className="text-blue-900/60 font-bold tracking-[0.3em] text-[10px] uppercase mb-12">Illustration & Design Works</p>
              <div className="flex gap-4 justify-center">
                <button onClick={() => setCurrentPage('portfolio')} className="px-8 py-3 bg-white text-cyan-600 rounded-full font-black text-xs shadow-xl hover:bg-blue-50 transition-colors">GALLERY</button>
                <button onClick={() => setCurrentPage('menu')} className="px-8 py-3 bg-cyan-600 text-white rounded-full font-black text-xs shadow-xl hover:bg-cyan-700 transition-colors">ORDER MENU</button>
              </div>
            </div>
          </div>
        );
    }
  };

  return (
    <div className="min-h-screen bg-[#F0F9FF]">
      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] w-[90%] max-w-md bg-white/80 backdrop-blur-xl rounded-full p-2 shadow-2xl border border-white flex justify-around">
        {[
          { id: 'home', icon: <Home className="w-5 h-5" /> },
          { id: 'profile', icon: <UserIcon className="w-5 h-5" /> },
          { id: 'portfolio', icon: <ImageIcon className="w-5 h-5" /> },
          { id: 'menu', icon: <MenuIcon className="w-5 h-5" /> },
          { id: 'contact', icon: <Mail className="w-5 h-5" /> }
        ].map(nav => (
          <button 
            key={nav.id} 
            onClick={() => setCurrentPage(nav.id)} 
            className={`p-3 rounded-full transition-all duration-300 ${currentPage === nav.id ? 'bg-cyan-500 text-white shadow-lg scale-110' : 'text-slate-300 hover:text-slate-400'}`}
          >
            {nav.icon}
          </button>
        ))}
      </nav>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="min-h-screen">
        {renderContent()}
      </div>

      {/* ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {isAdminOpen && (
        <div className="fixed inset-0 z-[200] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl relative">
            <button onClick={() => {setIsAdminOpen(false); setIsAuth(false);}} className="absolute top-6 right-6 text-slate-300 hover:text-slate-900"><X className="w-6 h-6" /></button>
            {!isAuth ? (
              <div className="text-center">
                <Lock className="w-12 h-12 text-blue-100 mx-auto mb-6" />
                <h3 className="font-black mb-6">ADMIN LOGIN</h3>
                <input 
                  type="password" 
                  placeholder="Password" 
                  className="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 mb-4 focus:outline-cyan-400" 
                  onChange={e => setAdminPass(e.target.value)} 
                  onKeyDown={e => e.key === 'Enter' && (adminPass === 'medaka' ? setIsAuth(true) : alert("No"))}
                />
                <button onClick={() => adminPass === 'medaka' ? setIsAuth(true) : alert("No")} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black hover:bg-slate-800 transition-colors">LOGIN</button>
              </div>
            ) : (
              <div className="space-y-4">
                <h3 className="font-black mb-4">ä½œå“ã®æ”¾æµ</h3>
                <div className="space-y-2">
                  <input type="text" placeholder="ä½œå“å" className="w-full px-5 py-3 rounded-xl border border-slate-100 bg-slate-50" value={newPost.title} onChange={e => setNewPost({...newPost, title: e.target.value})} />
                  <input type="text" placeholder="ç”»åƒURL" className="w-full px-5 py-3 rounded-xl border border-slate-100 bg-slate-50" value={newPost.url} onChange={e => setNewPost({...newPost, url: e.target.value})} />
                </div>
                <button onClick={addWork} className="w-full py-4 bg-cyan-600 text-white rounded-2xl font-black hover:bg-cyan-700 transition-colors">æ°´æ§½ã«è¿½åŠ </button>
              </div>
            )}
          </div>
        </div>
      )}
      
      {/* å…±é€šãƒ•ãƒƒã‚¿ãƒ¼ */}
      {currentPage !== 'home' && (
        <footer className="py-20 text-center opacity-30 text-[10px] font-bold tracking-[0.3em]">
          Â© 2026 MEDAKA AQUARIUM
        </footer>
      )}
    </div>
  );
};

export default App;