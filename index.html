<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>めだか村 | Medaka Village Portfolio</title>
    
    <!-- React & Babel (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SortableJS (for Drag & Drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Noto Sans JP', sans-serif;
            background-color: #f0f9ff;
            color: #334155;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- 物理挙動アコーディオン --- */
        .accordion-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
            opacity: 0;
        }
        .accordion-content.open {
            grid-template-rows: 1fr;
            opacity: 1;
        }
        .accordion-inner {
            min-height: 0;
        }

        /* --- Image Protection --- */
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- Animations --- */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-110vh) scale(1.2); opacity: 0; }
        }
        .bubble {
            position: fixed;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }
        
        .fade-in-up {
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Topバナー用スライドアニメーション */
        @keyframes fadeInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        /* トースト通知のアニメーション */
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* カスタムスライダー */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #0ea5e9;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* --- Utilities --- */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px -5px rgba(14, 165, 233, 0.1);
        }
        .text-shadow {
            text-shadow: 0 2px 10px rgba(14, 165, 233, 0.2);
        }
        
        .nav-active {
            background-color: #0ea5e9;
            color: white !important;
            box-shadow: 0 8px 16px -4px rgba(14, 165, 233, 0.4);
            transform: translateY(-2px) scale(1.05);
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #f0f9ff;
            border: 2px dashed #0ea5e9;
        }
        .sortable-drag {
            cursor: grabbing;
        }
        
        /* スクロールバー非表示 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* サムネイル画像の基本スタイル */
        .thumb-img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK & App Logic -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInWithEmailAndPassword, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, writeBatch, setDoc } from 'https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js';
        
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6EykukmTI7K-nQ7NC4s-Qz7rGflb1yEI",
            authDomain: "medapappa-pf.firebaseapp.com",
            projectId: "medapappa-pf",
            storageBucket: "medapappa-pf.firebasestorage.app",
            messagingSenderId: "503504281417",
            appId: "1:503504281417:web:8d4c101079dbe5e603c498",
            measurementId: "G-DTTWY94S1V"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
        
        const appId = 'medaka-final-v3';

        // --- Icons (SVG) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                home: (
                    <>
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                        <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                    </>
                ),
                image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="8.5" cy="8.5" r="1.5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M21 15l-5-5L5 21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                menu: (
                    <>
                        <rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                        <line x1="9" y1="8" x2="15" y2="8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        <line x1="9" y1="12" x2="15" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                        <line x1="9" y1="16" x2="13" y2="16" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    </>
                ),
                user: <><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                chevronLeft: <path d="M15 18l-6-6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                chevronDown: <path d="M6 9l6 6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>,
                info: <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><path d="M12 16v-4M12 8h.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                x: <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                send: <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                clock: <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><path d="M12 6v6l4 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                check: <path d="M20 6L9 17l-5-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                mail: <><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/><path d="M22 6l-10 7L2 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                twitter: <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="currentColor" />,
                copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                alert: <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                fish: <><path d="M2,12 C5,6.5 13,5.5 18,10.5 L21,9 L21,15 L18,13.5 C13,18.5 5,17.5 2,12Z" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round" fill="none"/><circle cx="7" cy="11.5" r="1.2" fill="currentColor"/></>,
                star: <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>,
                arrowDown: <path d="M12 5v14M19 12l-7 7-7-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/></>,
                edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                trash: <><path d="M3 6h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                video: <><path d="M23 7l-7 5 7 5V7z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                play: <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><path d="M10 8l6 4-6 4V8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />,
                external: <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
                gift: <><rect x="3" y="8" width="18" height="4" rx="1" stroke="currentColor" strokeWidth="2"/><path d="M12 8v13" stroke="currentColor" strokeWidth="2"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7" stroke="currentColor" strokeWidth="2"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5" stroke="currentColor" strokeWidth="2"/></>,
                pixiv: <><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><path d="M10 8h2a3 3 0 0 1 0 6h-2v4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
                pencil: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>,
                gamepad: <><rect x="2" y="6" width="20" height="12" rx="2" stroke="currentColor" strokeWidth="2"/><path d="M6 12h4m-2-2v4" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><circle cx="15" cy="13" r="0.5" fill="currentColor"/><circle cx="18" cy="11" r="0.5" fill="currentColor"/></>,
                sketchbook: <><rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" strokeWidth="2"/><path d="M8 4v4m4-4v4m4-4v4" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></>,
                grip: <><circle cx="9" cy="6" r="1.5" fill="currentColor"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="9" cy="18" r="1.5" fill="currentColor"/><circle cx="15" cy="6" r="1.5" fill="currentColor"/><circle cx="15" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="18" r="1.5" fill="currentColor"/></>,
                move: <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M19 9l3 3-3 3M15 19l-3 3-3-3M9 12h6M12 9v6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            };
            
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" className={className} xmlns="http://www.w3.org/2000/svg">
                    {icons[name] || null}
                </svg>
            );
        };

        // --- Helper: YouTube ID & Thumbnail ---
        const getYouTubeVideoId = (url) => {
            if (!url) return null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('youtu.be')) return urlObj.pathname.slice(1);
                if (urlObj.hostname.includes('youtube.com')) {
                    if (urlObj.pathname.startsWith('/shorts/')) return urlObj.pathname.split('/shorts/')[1];
                    if (urlObj.pathname.startsWith('/live/')) return urlObj.pathname.split('/live/')[1];
                    if (urlObj.pathname.startsWith('/embed/')) return urlObj.pathname.split('/embed/')[1];
                    if (urlObj.searchParams.has('v')) return urlObj.searchParams.get('v');
                }
            } catch (e) { return null; }
            return null;
        };

        const getYouTubeThumbnail = (url) => {
            const videoId = getYouTubeVideoId(url);
            if (videoId) return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            return null;
        };

        const getYouTubeEmbedUrl = (url) => {
            const videoId = getYouTubeVideoId(url);
            if (videoId) {
                const cleanId = videoId.split(/[?#&/]/)[0];
                return `https://www.youtube.com/embed/${cleanId}?playsinline=1&rel=0&modestbranding=1`;
            }
            return url; 
        };

        // --- Helper: Universal Thumbnail Component ---
        const SmartThumbnail = ({ src, position, className = "", alt = "" }) => {
            const x = position?.x ?? 50;
            const y = position?.y ?? 50;
            const scale = position?.scale ?? 100;
            
            return (
                <div className={`relative overflow-hidden bg-slate-100 ${className}`}>
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                         <img src={src} alt="" className="w-full h-full object-cover filter blur-md brightness-110 scale-110" />
                    </div>
                    <img 
                        src={src} 
                        alt={alt}
                        className="thumb-img absolute top-0 left-0 transition-transform duration-0 relative z-10" 
                        style={{ transform: `scale(${scale / 100}) translate(${(x - 50) * 2}%, ${(y - 50) * 2}%)` }}
                    />
                </div>
            );
        };

        // --- 無限カルーセルコンポーネント ---
        const AutoScrollCarousel = ({ items }) => {
            const viewportRef = useRef(null);
            const isDragging = useRef(false);
            const startX = useRef(0);
            const scrollLeftStart = useRef(0);
            const animationRef = useRef(null);
            const exactScrollLeft = useRef(0); 

            const repeatedItems = useMemo(() => {
                if (!items || items.length === 0) return [];
                const shuffled = [...items].sort(() => 0.5 - Math.random());
                return Array.from({ length: 20 }).flatMap(() => shuffled);
            }, [items]);

            useEffect(() => {
                if (repeatedItems.length === 0) return;
                const viewport = viewportRef.current;
                exactScrollLeft.current = viewport.scrollLeft;
                
                const step = () => {
                    if (!isDragging.current) {
                        exactScrollLeft.current += 0.12; 
                        if (exactScrollLeft.current >= viewport.scrollWidth / 2) {
                            exactScrollLeft.current -= viewport.scrollWidth / 2;
                        }
                        viewport.scrollLeft = exactScrollLeft.current;
                    } else {
                        exactScrollLeft.current = viewport.scrollLeft;
                    }
                    animationRef.current = requestAnimationFrame(step);
                };
                animationRef.current = requestAnimationFrame(step);
                return () => cancelAnimationFrame(animationRef.current);
            }, [repeatedItems.length]);

            const handlers = {
                onMouseDown: (e) => {
                    isDragging.current = true;
                    startX.current = e.pageX - viewportRef.current.offsetLeft;
                    scrollLeftStart.current = viewportRef.current.scrollLeft;
                    viewportRef.current.style.cursor = 'grabbing';
                },
                onMouseLeave: () => { isDragging.current = false; if(viewportRef.current) viewportRef.current.style.cursor = 'grab'; },
                onMouseUp: () => { isDragging.current = false; if(viewportRef.current) viewportRef.current.style.cursor = 'grab'; },
                onMouseMove: (e) => {
                    if (!isDragging.current) return;
                    e.preventDefault();
                    const x = e.pageX - viewportRef.current.offsetLeft;
                    const walk = (x - startX.current) * 1.5; 
                    let newScrollLeft = scrollLeftStart.current - walk;
                    if (newScrollLeft >= viewportRef.current.scrollWidth / 2) {
                        newScrollLeft -= viewportRef.current.scrollWidth / 2;
                        scrollLeftStart.current -= viewportRef.current.scrollWidth / 2; 
                    } else if (newScrollLeft <= 0) {
                        newScrollLeft += viewportRef.current.scrollWidth / 2;
                        scrollLeftStart.current += viewportRef.current.scrollWidth / 2;
                    }
                    viewportRef.current.scrollLeft = newScrollLeft;
                },
                onTouchStart: (e) => {
                    isDragging.current = true;
                    startX.current = e.touches[0].pageX - viewportRef.current.offsetLeft;
                    scrollLeftStart.current = viewportRef.current.scrollLeft;
                },
                onTouchEnd: () => { isDragging.current = false; },
                onTouchMove: (e) => {
                    if (!isDragging.current) return;
                    const x = e.touches[0].pageX - viewportRef.current.offsetLeft;
                    const walk = (x - startX.current) * 1.5;
                    let newScrollLeft = scrollLeftStart.current - walk;
                    if (newScrollLeft >= viewportRef.current.scrollWidth / 2) {
                        newScrollLeft -= viewportRef.current.scrollWidth / 2;
                        scrollLeftStart.current -= viewportRef.current.scrollWidth / 2;
                    } else if (newScrollLeft <= 0) {
                        newScrollLeft += viewportRef.current.scrollWidth / 2;
                        scrollLeftStart.current += viewportRef.current.scrollWidth / 2;
                    }
                    viewportRef.current.scrollLeft = newScrollLeft;
                }
            };

            if (!items || items.length === 0) return null;

            return (
                <div ref={viewportRef} className="overflow-hidden cursor-grab w-full flex select-none no-scrollbar py-4" {...handlers} style={{ scrollBehavior: 'auto' }}>
                    <div className="flex gap-4 md:gap-6 px-4 w-max">
                        {repeatedItems.map((work, index) => (
                            <div key={`${work.id}-${index}`} className="w-36 h-36 md:w-52 md:h-52 shrink-0 bg-white rounded-[2rem] shadow-sm border border-sky-50 overflow-hidden relative pointer-events-none transition-transform hover:scale-[1.02]">
                                <SmartThumbnail 
                                    src={work.media && work.media.length > 0 ? (work.media[0].type === 'image' ? work.media[0].url : getYouTubeThumbnail(work.media[0].url)) : (work.urls ? work.urls[0] : '')}
                                    position={work.thumbnailPosition}
                                    className="w-full h-full"
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Components ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            if (!message) return null;

            return ReactDOM.createPortal(
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[9999] px-6 py-3 rounded-full shadow-lg font-bold text-sm text-white flex items-center gap-2 toast-enter ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
                    <Icon name={type === 'error' ? 'alert' : 'check'} size={18} />
                    {message}
                </div>,
                document.body
            );
        };

        const Bubbles = () => {
            const bubbles = useMemo(() => Array.from({ length: 12 }).map((_, i) => ({
                id: i,
                size: Math.random() * 20 + 5,
                left: Math.random() * 100,
                duration: Math.random() * 8 + 8,
                delay: Math.random() * 5
            })), []);

            return (
                <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
                    {bubbles.map(b => (
                        <div key={b.id} className="bubble" style={{
                            width: `${b.size}px`, height: `${b.size}px`,
                            left: `${b.left}%`, bottom: '-30px',
                            animation: `floatUp ${b.duration}s linear infinite`,
                            animationDelay: `${b.delay}s`
                        }}></div>
                    ))}
                </div>
            );
        };

        const WaveDivider = ({ className = "absolute bottom-0" }) => (
            <div className={`${className} w-full leading-[0] z-20 overflow-hidden`}>
                <svg viewBox="0 0 1200 120" preserveAspectRatio="none" className="relative block w-full h-12 md:h-20 drop-shadow-sm">
                    <path d="M0,20 C150,80 280,5 420,45 C560,85 650,15 780,35 C910,55 1050,90 1200,25 V120 H0 Z" fill="#f0f9ff"></path>
                </svg>
            </div>
        );

        // --- Data Definitions ---
        const DEFAULT_CATEGORIES = [
            { 
                id: 'standard', 
                name: '等身イラスト', 
                sub: 'Standard Illustration', 
                price: '12,000', 
                desc: '配信、アクリルスタンド、MVなど多目的に使用できる高品質なイラストです。キャラクターの魅力を引き出す「生きた」立ち姿を制作します。', 
                basePrices: [
                    { label: 'キャラクター全身', price: '¥15,000〜' }, 
                    { label: '腰上（ニーアップ）', price: '¥14,000〜' }, 
                    { label: '胸上（バストアップ）', price: '¥12,000〜' }
                ], 
                specs: '長辺～4000px前後 / 350dpi / 透過PNG / 納期1ヶ月～\n※画像サイズやファイル形式のご指定がある場合は、事前にお申し付けください。', 
                options: [
                    { label: '新規キャラクターデザイン', price: '＋¥15,000〜' }, 
                    { label: '新規衣装デザイン', price: '＋¥8,000〜' }, 
                    { label: '「ぴょこぴょこ」口パク差分（配信向け）', price: '＋¥1,000' },
                    { label: '表情差分（1種につき）', price: '＋¥2,000〜' }, 
                    { label: '衣装・ポーズ差分', price: '＋¥3,000〜' },
                    { label: '背景追加（風景・室内など）', price: '＋¥10,000〜' },
                    { label: '簡単な背景（パターン・空など）', price: '＋¥2,000〜' }
                ], 
                otherOptions: [],
                optionNote: '',
                recommends: ['VTuber活動のメインモデルや新衣装制作に', '歌ってみたMVで「動き」や「遠近法」を感じさせる一枚が欲しい方に', 'グッズ化した際に細部まで綺麗なイラストを求めている方に'] 
            },
            { 
                id: 'sd', 
                name: 'SDイラスト', 
                sub: 'Mini Character', 
                price: '5,000', 
                desc: 'SNSアイコン、LINEスタンプ、グッズ制作に最適なミニキャラクターです。用途に合わせて最適な頭身・絵柄で描き分けます。', 
                basePrices: [
                    { label: 'SD全身', price: '¥8,000〜' }, 
                    { label: 'SDバストアップ', price: '¥5,000〜' }
                ], 
                specs: '2000px正方形前後 / 350dpi / 透過PNG / 納期1ヶ月～\n※用途（スタンプ用、アクキー用など）に合わせたサイズ指定も可能です。\n※画像サイズやファイル形式のご指定がある場合は、事前にお申し付けください。', 
                options: [
                    { label: '新規キャラクターデザイン', price: '＋¥10,000〜' }, 
                    { label: '新規衣装デザイン', price: '＋¥8,000〜' }, 
                    { label: '表情差分（1種につき）', price: '＋¥500〜' }, 
                    { label: '小物・ポーズ差分', price: '＋¥2,000〜' },
                    { label: '小物背景追加', price: '＋¥7,000〜' },
                    { label: '背景追加（風景・室内など）', price: '＋¥5,000〜' },
                    { label: '簡単な背景（単色・パターンなど）', price: '＋¥0〜' }
                ], 
                otherOptions: [
                    { label: 'LINEスタンプ・バッジ用まとめ制作', price: '要相談' },
                    { label: '顔だけアイコンセット（表情差分5種〜）', price: '¥8,000〜' }
                ],
                optionNote: '※顔だけアイコン内訳：基本料金¥3,000 ＋ 追加1種につき¥1,000〜',
                recommends: ['YouTubeメンバーシップのバッジやスタンプを揃えたい方に', '配信画面の隅で「ぴょこぴょこ」動く可愛い素材が欲しい方に', '動画編集でテロップに合わせて表情を細かく変えたい方に'] 
            },
            { 
                id: 'thumb', 
                name: 'ゲーム実況・動画サムネイル', 
                sub: 'Thumbnail Design', 
                price: '4,000', 
                desc: '「ついクリックしたくなる」視聴者目線の画面構成を提供します。これまでの実況動画制作ノウハウを活かした、インパクト重視のレイアウトです。', 
                basePrices: [{ label: 'サムネイル制作', price: '¥4,000〜' }], 
                specs: '1280×720〜1920×1080px / 72dpi / PNG / 納期2週間～\n※キャラクターレタッチ、背景合成、タイトルロゴ装飾を含みます。\n※イラスト自体の描き起こしは含まれません。等身/SDメニューと併せてご依頼ください。', 
                options: [
                    { label: '特急制作（3日以内納品）', price: '＋¥2,000' }, 
                    { label: '同一シリーズの差分制作', price: '＋¥2,000〜' },
                    { label: 'PSDデータ納品', price: '＋¥3,000' }
                ], 
                otherOptions: [],
                optionNote: '',
                recommends: ['ゲーム実況動画のクリック率（CTR）を改善したい方に', '自分のキャラクターを動画の世界観に馴染ませて配置したい方に', '忙しくてサムネイルまで手が回らない実況者様に'] 
            },
            { 
                id: 'skeb', 
                name: 'Skeb', 
                sub: 'Quick Request', 
                price: '', 
                desc: '細かい打ち合わせなしで、個人利用向けのイラストを気軽にリクエストできるサービスです。', 
                basePrices: [
                    { label: 'おまかせ金額', price: '¥10,000〜' },
                    { label: '最低金額', price: '¥8,000〜' }
                ],
                priceNote: '※この金額での依頼を強制するものではありません。\nあくまで、金額設定はクライアント様のご判断にお任せします。',
                specs: '原則リテイクなし / 個人利用のみ / 納期3週間～1ヶ月\n※Skebの利用規約に準拠します。\n※商用利用はできません。',
                options: [{ label: '商用利用', price: '不可' }, { label: 'リテイク', price: '不可' }], 
                recommends: ['推しへのプレゼントイラストを描いてほしい方に', 'ご依頼のやり取りを省略したい方に', '納品までのワクワク感を楽しみたい方に'],
                externalLink: 'https://skeb.jp/@medapappa',
                buttonText: 'Skebでリクエストする'
            }
        ];

        const SAMPLE_WORKS = [
            { id: 'sample_1', title: '全身立ち絵サンプル', media: [{ type: 'image', url: 'https://placehold.jp/48/0ea5e9/ffffff/800x1200.png?text=SAMPLE' }], category: '等身イラスト', tags: ['キャラクター全身'], time: '15h', focus: 'パーツ分けを意識した線画。', thumbnailPosition: { x: 50, y: 0, scale: 150 } },
            { id: 'sample_2', title: 'SDキャラ・ショート動画', media: [{ type: 'youtube', url: 'https://youtube.com/shorts/MZs9geC7Qpo' }], category: 'SDイラスト', tags: ['SD全身', '動画'], time: '5h', focus: '動くSDキャラクター。', thumbnailPosition: { x: 50, y: 50, scale: 150 } }
        ];

        const NAV_ITEMS = [
            { id: 'home', icon: 'home' },
            { id: 'portfolio', icon: 'image' },
            { id: 'menu', icon: 'menu' },
            { id: 'contact', icon: 'send' },
            { id: 'profile', icon: 'user' } 
        ];

        const TEMPLATE_TEXT = `【ご依頼内容詳細テンプレート】\n①ご依頼内容：\n②使用用途：\n③商用利用の有無：\n④画像サイズ / 形式：\n⑤希望納期：\n⑥実績公開の可否：\n\n【キャラクター詳細】\n・性別 / 年齢：\n・髪型 / 色：\n・目の形 / 色：\n・性格 / イメージカラー：\n・衣装 / ポーズ：\n・背景：\n・その他備考：`;

        const SOCIAL_LINKS = [
            { name: 'Foriio', url: 'https://www.foriio.com/medapappa', icon: 'sketchbook' },
            { name: 'Poipiku', url: 'https://poipiku.com/3326364/', icon: 'pencil' },
            { name: 'Wishlist', url: 'https://www.amazon.co.jp/registry/wishlist/19J7QF4JGH4FJ/', icon: 'gift' },
            { name: 'Sub', url: 'https://x.com/pappatoon', icon: 'twitter' }
        ];

        // --- Helper: SortableJS Component ---
        const SortableList = ({ items, onSortEnd, renderItem, className = "", disabled = false }) => {
            const listRef = useRef(null);
            const sortableRef = useRef(null);
            
            const onSortEndRef = useRef(onSortEnd);
            useEffect(() => { onSortEndRef.current = onSortEnd; }, [onSortEnd]);

            useEffect(() => {
                if (!listRef.current) return;
                sortableRef.current = new Sortable(listRef.current, {
                    animation: 250, 
                    easing: "cubic-bezier(0.25, 1, 0.5, 1)", 
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    handle: '.drag-handle',
                    disabled: disabled,
                    onEnd: (evt) => {
                        if (evt.oldIndex === evt.newIndex) return;
                        
                        const item = evt.item;
                        const parent = evt.from;
                        parent.removeChild(item);
                        
                        if (evt.oldIndex < parent.children.length) {
                            parent.insertBefore(item, parent.children[evt.oldIndex]);
                        } else {
                            parent.appendChild(item);
                        }
                        
                        onSortEndRef.current(evt.oldIndex, evt.newIndex);
                    }
                });
                return () => sortableRef.current.destroy();
            }, []);

            useEffect(() => {
                if (sortableRef.current) {
                    sortableRef.current.option('disabled', disabled);
                }
            }, [disabled]);

            if (!items || !Array.isArray(items)) return null;

            return <div ref={listRef} className={className}>{items.map((item, index) => renderItem(item, index))}</div>;
        };

        // --- PriceAccordion Component ---
        const PriceAccordion = ({ openMenuId, setOpenMenuId, dynamicCategories, portfolio, setSelectedWork, setWorkImgIndex, changePage, setFilterCategory }) => {
            return (
                <div className="space-y-4">
                    {dynamicCategories.map(c => {
                        const isOpen = openMenuId === c.id;
                        const sampleIds = c.sampleWorks || [];
                        const categoryWorks = sampleIds.map(id => portfolio?.find(w => w.id === id)).filter(Boolean);
                        
                        return (
                            <div key={c.id} className={`bg-white/80 rounded-2xl border transition-all duration-300 ${isOpen ? 'border-sky-300 shadow-lg ring-4 ring-sky-50/50' : 'border-sky-50 shadow-sm'}`}>
                                <button 
                                    className="w-full px-6 py-4 flex justify-between items-center text-slate-700 hover:bg-sky-50/50 transition-colors rounded-2xl outline-none"
                                    onClick={() => setOpenMenuId(isOpen ? null : c.id)}
                                >
                                    <div className="flex flex-col items-start gap-1 flex-1 min-w-0 mr-2 text-left">
                                        <div className="flex items-center gap-3 font-bold w-full">
                                            <span className={`w-2 h-2 rounded-full transition-all duration-500 flex-shrink-0 ${isOpen ? 'bg-sky-500 scale-125' : 'bg-slate-200'}`}></span>
                                            <span className="text-xs sm:text-sm md:text-base whitespace-nowrap overflow-hidden text-ellipsis">{c.name.replace('■ ', '')}</span>
                                        </div>
                                        <span className="text-[10px] text-slate-400 pl-5 tracking-wider truncate w-full">{c.sub}</span>
                                    </div>
                                    <div className="flex items-center gap-3 flex-shrink-0">
                                        <div className="text-right">
                                            {c.price && (
                                                <div className="flex items-center gap-2">
                                                    {c.isSale && c.salePrice ? (
                                                        <>
                                                            <span className="text-[10px] font-bold text-slate-400 line-through">¥{c.price}〜</span>
                                                            <span className="text-sm font-black text-rose-400 italic">¥{c.salePrice}〜</span>
                                                        </>
                                                    ) : (
                                                        <span className="text-sm font-black text-sky-500 italic">¥{c.price}〜</span>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        <div className={`transition-transform duration-300 ${isOpen ? 'rotate-180 text-sky-500' : 'text-slate-300'}`}>
                                            <Icon name="chevronDown" size={18} />
                                        </div>
                                    </div>
                                </button>
                                
                                <div className={`accordion-content ${isOpen ? 'open' : ''}`}>
                                    <div className="accordion-inner">
                                        <div className="px-6 pb-8 pt-2 border-t border-slate-100/50 space-y-6">
                                            <p className="text-xs text-slate-500 font-medium italic border-l-2 border-sky-200 pl-3 leading-relaxed text-left">{c.desc}</p>
                                            
                                            <div>
                                                <h4 className="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1"><span className="w-1 h-4 bg-sky-400 rounded-full"></span>基本料金</h4>
                                                <div className="space-y-1">
                                                    {c.basePrices && c.basePrices.map((bp, i) => (
                                                        <div key={i} className="flex justify-between items-center text-xs border-b border-slate-100 pb-1 mb-1 last:border-0">
                                                            <span className={`text-slate-600 ${bp.isStopped ? 'line-through opacity-50' : ''}`}>{bp.label}</span>
                                                            <div className="flex items-center gap-2">
                                                                {bp.isStopped ? (
                                                                    <span className="font-bold text-slate-400">受付停止</span>
                                                                ) : bp.isSale && bp.salePrice ? (
                                                                    <>
                                                                        <span className="font-bold text-slate-400 line-through text-[10px]">{bp.price}</span>
                                                                        <span className="font-bold text-rose-400">{bp.salePrice}</span>
                                                                    </>
                                                                ) : (
                                                                    <span className="font-bold text-sky-600">{bp.price}</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                {c.id === 'skeb' && c.priceNote && (
                                                    <p className="text-[10px] text-slate-400 mt-2 text-right whitespace-pre-line">{c.priceNote}</p>
                                                )}
                                            </div>

                                            <div className="bg-sky-50/50 p-4 rounded-xl text-[10px] border border-sky-100 text-left">
                                                <p className="font-bold text-sky-600 mb-1 uppercase tracking-widest flex items-center gap-1"><Icon name="info" size={10}/> Basic Specs</p>
                                                <p className="text-slate-700 whitespace-pre-wrap leading-relaxed">{c.specs}</p>
                                            </div>
                                            
                                            {c.options && c.options.length > 0 && (
                                                <div>
                                                    <h4 className="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1"><span className="w-1 h-4 bg-indigo-400 rounded-full"></span>オプション</h4>
                                                    <div className="space-y-1">
                                                        {c.options.map((opt, i) => (
                                                            <div key={i} className={`flex justify-between items-center bg-white px-3 py-2 rounded-lg text-[10px] border border-slate-100`}>
                                                                <span className={`text-slate-500 font-bold ${opt.isStopped ? 'line-through opacity-50' : ''}`}>{opt.label}</span>
                                                                <div className="flex items-center gap-2">
                                                                    {opt.isStopped ? (
                                                                        <span className="font-bold text-slate-400">受付停止</span>
                                                                    ) : opt.isSale && opt.salePrice ? (
                                                                        <>
                                                                            <span className="font-bold text-slate-400 line-through text-[9px]">{opt.price}</span>
                                                                            <span className="font-black text-rose-400">{opt.salePrice}</span>
                                                                        </>
                                                                    ) : (
                                                                        <span className="font-black text-indigo-500">{opt.price}</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {((c.otherOptions && c.otherOptions.length > 0) || (c.optionNote && c.id !== 'skeb')) && (
                                                <div className="space-y-2">
                                                    {c.otherOptions && c.otherOptions.length > 0 && (
                                                        <div>
                                                            <h4 className="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1"><span className="w-1 h-4 bg-pink-400 rounded-full"></span>その他オプション</h4>
                                                            <div className="space-y-1">
                                                                {c.otherOptions.map((opt, i) => (
                                                                    <div key={i} className={`flex justify-between items-center bg-white px-3 py-2 rounded-lg text-[10px] border border-slate-100`}>
                                                                        <span className={`text-slate-500 font-bold ${opt.isStopped ? 'line-through opacity-50' : ''}`}>{opt.label}</span>
                                                                        <div className="flex items-center gap-2">
                                                                            {opt.isStopped ? (
                                                                                <span className="font-bold text-slate-400">受付停止</span>
                                                                            ) : opt.isSale && opt.salePrice ? (
                                                                                <>
                                                                                    <span className="font-bold text-slate-400 line-through text-[9px]">{opt.price}</span>
                                                                                    <span className="font-black text-rose-400">{opt.salePrice}</span>
                                                                                </>
                                                                            ) : (
                                                                                <span className="font-black text-pink-500">{opt.price}</span>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {c.optionNote && c.id !== 'skeb' && (
                                                        <p className="text-[10px] text-slate-400 text-right whitespace-pre-line leading-relaxed">{c.optionNote}</p>
                                                    )}
                                                </div>
                                            )}

                                            {(categoryWorks.length > 0 || c.id !== 'skeb') && (
                                                <div className="mt-4 pt-4 border-t border-slate-100/50">
                                                    {categoryWorks.length > 0 && (
                                                        <>
                                                            <div className="flex justify-between items-end mb-1.5">
                                                                <h4 className="text-[11px] font-bold text-slate-700 flex items-center gap-1"><Icon name="image" size={14} className="text-sky-400"/> サンプル</h4>
                                                                <span className="text-[9px] text-slate-400 font-medium">クリックで拡大</span>
                                                            </div>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                {categoryWorks.map(w => (
                                                                    <button key={w.id} onClick={(e) => { e.stopPropagation(); setSelectedWork(w); setWorkImgIndex(0); }} className="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all hover:scale-105 border border-slate-100 relative group">
                                                                        <SmartThumbnail 
                                                                            src={w.media && w.media[0] ? (w.media[0].type === 'image' ? w.media[0].url : getYouTubeThumbnail(w.media[0].url)) : ''} 
                                                                            position={w.thumbnailPosition} 
                                                                            className="w-full h-full" 
                                                                        />
                                                                        <div className="absolute inset-0 bg-sky-900/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </>
                                                    )}
                                                    {c.id !== 'skeb' && (
                                                        <div className={`flex justify-end ${categoryWorks.length > 0 ? 'mt-2' : ''}`}>
                                                            <button onClick={(e) => { e.stopPropagation(); changePage('portfolio'); setFilterCategory(c.name.replace('■ ', '')); }} className="text-[10px] text-sky-500 font-bold flex items-center gap-1 hover:underline hover:text-sky-600 transition-colors">
                                                                もっと見る <Icon name="chevronLeft" size={12} className="rotate-180" />
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {c.externalLink && (
                                                <div className="mt-6 pt-6 border-t border-slate-100 flex justify-center">
                                                    <a href={c.externalLink} target="_blank" rel="noopener noreferrer" className="group flex items-center justify-center gap-2 w-full max-w-[280px] bg-teal-500 text-white py-4 rounded-full font-bold text-xs shadow-md shadow-teal-600/30 hover:bg-teal-400 hover:shadow-lg hover:shadow-teal-600/40 hover:-translate-y-0.5 transition-all tracking-widest">
                                                        <div className="flex items-center gap-3">
                                                            <Icon name="sketchbook" size={16} />
                                                            <span>{c.buttonText || '詳しく見る'}</span>
                                                        </div>
                                                    </a>
                                                </div>
                                            )}
                                            
                                            {c.recommends && c.recommends.length > 0 && (
                                                <div className="bg-white border border-slate-100 rounded-xl p-4 mt-4">
                                                    <h4 className="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1"><Icon name="star" size={12} className="text-yellow-400"/>こんな方におすすめ</h4>
                                                    <ul className="text-[10px] text-slate-500 list-disc pl-4 space-y-1 text-left">
                                                        {c.recommends.map((rec, i) => <li key={i}>{rec}</li>)}
                                                    </ul>
                                                </div>
                                            )}

                                            {/* 閉じるボタン */}
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); setOpenMenuId(null); }}
                                                className="w-full flex items-center justify-center pt-2 mt-2 text-slate-300 hover:text-sky-500 transition-colors"
                                            >
                                                <Icon name="chevronDown" size={20} className="rotate-180" />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- Admin Components ---
        const AdminPage = ({ changePage, db, appId, portfolio, siteSettings, prevPage, dynamicCategories, setGlobalNotification }) => {
            const [password, setPassword] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [activeTab, setActiveTab] = useState('hub');
            const [galleryMode, setGalleryMode] = useState('manage'); 
            const [openMenuEditIds, setOpenMenuEditIds] = useState([]);
            const [editingId, setEditingId] = useState(null);
            
            const [localPortfolio, setLocalPortfolio] = useState([]);
            const [hasOrderChanged, setHasOrderChanged] = useState(false);
            const [manageFilter, setManageFilter] = useState('ALL');
            const [manageViewMode, setManageViewMode] = useState('list');
            const [isSortMode, setIsSortMode] = useState(false);
            
            const [currentPageNum, setCurrentPageNum] = useState(1);

            const [templates, setTemplates] = useState(() => {
                try {
                    const saved = localStorage.getItem('medaka_title_templates');
                    return saved ? JSON.parse(saved) : ["【受託制作】等身イラスト / 〇〇様", "【受託制作】SDイラスト / 〇〇様", "動画サムネイル制作 / 〇〇様"];
                } catch (e) {
                    return ["【受託制作】等身イラスト / 〇〇様", "【受託制作】SDイラスト / 〇〇様", "動画サムネイル制作 / 〇〇様"];
                }
            });
            const [selectedTemplate, setSelectedTemplate] = useState('');
            
            const [settingsData, setSettingsData] = useState({ acceptStatus: '2026年3月頃', categoryPricing: {}, categorySamples: {} });

            useEffect(() => {
                setLocalPortfolio(portfolio || []);
            }, [portfolio]);

            useEffect(() => {
                setCurrentPageNum(1);
            }, [manageFilter, manageViewMode]);

            useEffect(() => {
                if (siteSettings) setSettingsData(siteSettings);
            }, [siteSettings]);

            const [itemData, setItemData] = useState({
                title: '', category: '', tags: [], time: '10h', focus: '', media: [{ type: 'image', url: '' }], thumbnailPosition: { x: 50, y: 50, scale: 100 }
            });

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const myEmail = "medapappa@gmail.com";
                    await signInWithEmailAndPassword(auth, myEmail, password);
                    setIsAuthenticated(true);
                    setPassword(''); 
                } catch (err) {
                    alert('ログインに失敗しました。');
                }
            };

            const resetForm = () => {
                setItemData({ title: '', category: '', tags: [], time: '10h', focus: '', media: [{ type: 'image', url: '' }], thumbnailPosition: { x: 50, y: 50, scale: 100 } });
                setEditingId(null);
            };

            const applyTitleTemplate = () => {
                const prefix = itemData.category ? `【受託制作】${itemData.category.replace('■ ', '')}` : "【受託制作】イラスト";
                const suffix = itemData.tags && itemData.tags.length > 0 ? ` / ${itemData.tags[0]}等` : " / 〇〇様";
                setItemData({ ...itemData, title: `${prefix}${suffix}` });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!itemData.title || !itemData.category || !itemData.media || itemData.media.length === 0 || !itemData.media[0].url) {
                    setGlobalNotification({ message: '必須項目を入力してください', type: 'error' });
                    return;
                }
                
                if (editingId && editingId.toString().startsWith('sample_')) {
                     setGlobalNotification({ message: 'サンプルデータは更新できません。', type: 'error' });
                     return;
                }

                try {
                    const cleanPos = { x: Number(itemData.thumbnailPosition?.x ?? 50), y: Number(itemData.thumbnailPosition?.y ?? 50), scale: Number(itemData.thumbnailPosition?.scale ?? 100) };
                    const data = { ...itemData, thumbnailPosition: cleanPos, updatedAt: serverTimestamp() };
                    
                    if (!editingId) {
                        data.createdAt = serverTimestamp();
                        const minOrder = portfolio && portfolio.length > 0 ? Math.min(...portfolio.map(p => p.order || 0)) : 0;
                        data.order = minOrder - 1;
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'works'), data);
                        setGlobalNotification({ message: '作品を追加しました！', type: 'success' });
                    } else {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'works', editingId), data);
                        setGlobalNotification({ message: '作品を更新しました！', type: 'success' });
                    }
                    resetForm();
                    setTimeout(() => setGalleryMode('manage'), 800);
                } catch (err) {
                    setGlobalNotification({ message: 'エラーが発生しました', type: 'error' });
                }
            };

            const handleSaveSettings = async (e) => {
                if(e) e.preventDefault();
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general'), settingsData);
                    setGlobalNotification({ message: 'サイトに反映しました！', type: 'success' });
                    setOpenMenuEditIds([]);
                } catch (err) {
                    setGlobalNotification({ message: '反映に失敗しました', type: 'error' });
                }
            };

            // 修正: 無条件でソースコード内の指定テンプレート（※1）を展開する緊急リセット機能
            const handleResetCategoryPricing = (catId) => {
                if(window.confirm('初期状態にしますか？\n※現在の入力内容は上書きされます。')) {
                    const defaultCat = DEFAULT_CATEGORIES.find(c => c.id === catId);
                    if(!defaultCat) return;
                    
                    const targetDefault = {
                        basePrices: JSON.parse(JSON.stringify(defaultCat.basePrices || [])),
                        options: JSON.parse(JSON.stringify(defaultCat.options || [])),
                        otherOptions: JSON.parse(JSON.stringify(defaultCat.otherOptions || [])),
                        optionNote: defaultCat.optionNote || ""
                    };
                    
                    setSettingsData(prev => {
                        const newPricing = { ...prev.categoryPricing };
                        newPricing[catId] = targetDefault;
                        return { ...prev, categoryPricing: newPricing };
                    });
                    
                    setGlobalNotification({ message: '初期状態（※1）に書き換えました。確認後「設定を反映する」を押してください。', type: 'success' });
                }
            };

            // 修正: ディープコピー（参照の更新）を行い、ドラッグドロップの変更を確実にReactに検知させる
            const handlePriceSortEnd = (catId, type, oldIdx, newIdx) => {
                setSettingsData(prev => {
                    const newPricing = { ...prev.categoryPricing };
                    if (!newPricing[catId]) return prev;
                    
                    const newArray = [...newPricing[catId][type]];
                    const [moved] = newArray.splice(oldIdx, 1);
                    newArray.splice(newIdx, 0, moved);
                    
                    // ここが重要：newPricing[catId] 自体の参照を新しくしないと再描画されない
                    newPricing[catId] = {
                        ...newPricing[catId],
                        [type]: newArray
                    };
                    
                    return { ...prev, categoryPricing: newPricing };
                });
            };

            const updatePricing = (catId, type, idx, field, val) => {
                setSettingsData(prev => {
                    const newPricing = { ...prev.categoryPricing };
                    if (!newPricing[catId]) {
                        const defaultCat = DEFAULT_CATEGORIES.find(c => c.id === catId);
                        newPricing[catId] = { basePrices: JSON.parse(JSON.stringify(defaultCat.basePrices||[])), options: JSON.parse(JSON.stringify(defaultCat.options||[])), otherOptions: JSON.parse(JSON.stringify(defaultCat.otherOptions||[])), optionNote: defaultCat.optionNote||"" };
                    }
                    newPricing[catId][type][idx][field] = val;
                    return { ...prev, categoryPricing: newPricing };
                });
            };
            const addPricingItem = (catId, type) => {
                setSettingsData(prev => {
                    const newPricing = { ...prev.categoryPricing };
                    if (!newPricing[catId]) {
                        const defaultCat = DEFAULT_CATEGORIES.find(c => c.id === catId);
                        newPricing[catId] = { basePrices: JSON.parse(JSON.stringify(defaultCat.basePrices||[])), options: JSON.parse(JSON.stringify(defaultCat.options||[])), otherOptions: JSON.parse(JSON.stringify(defaultCat.otherOptions||[])), optionNote: defaultCat.optionNote||"" };
                    }
                    newPricing[catId][type].push({label: '新規項目', price: '¥0'});
                    return { ...prev, categoryPricing: newPricing };
                });
            };
            const removePricingItem = (catId, type, idx) => {
                setSettingsData(prev => {
                    const newPricing = { ...prev.categoryPricing };
                    newPricing[catId][type].splice(idx, 1);
                    return { ...prev, categoryPricing: newPricing };
                });
            };
            
            const updateCategorySamples = (catId, newSamples) => {
                setSettingsData(prev => ({
                    ...prev,
                    categorySamples: { ...(prev.categorySamples || {}), [catId]: newSamples }
                }));
            };

            const handleEditClick = (work) => {
                if (work.id.toString().startsWith('sample_')) { alert('サンプルデータは編集できません。'); return; }
                setItemData({
                    title: work.title || '', category: work.category || '', tags: work.tags || [], time: work.time || '10h', focus: work.focus || '',
                    media: (work.media && work.media.length > 0) ? work.media : (work.urls && work.urls.length > 0 ? work.urls.map(u => ({ type: 'image', url: u })) : [{ type: 'image', url: '' }]),
                    thumbnailPosition: { x: work.thumbnailPosition?.x ?? 50, y: work.thumbnailPosition?.y ?? 50, scale: work.thumbnailPosition?.scale ?? 100 }
                });
                setEditingId(work.id); setGalleryMode('create'); window.scrollTo(0,0);
            };

            const handleDelete = async (id) => {
                if (id.toString().startsWith('sample_')) { alert('サンプルは削除できません。'); return; }
                if (window.confirm('本当に削除しますか？')) {
                    try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'works', id)); resetForm(); setGalleryMode('manage'); setGlobalNotification({ message: '削除しました', type: 'success' }); } catch (e) {}
                }
            };

            const handleSortEnd = (oldIndex, newIndex) => {
                if (oldIndex === newIndex) return;
                const offset = isSortMode ? 0 : (currentPageNum - 1) * itemsPerPage;
                const adjustedOld = offset + oldIndex;
                const adjustedNew = offset + newIndex;
                const filtered = manageFilter === 'ALL' ? [...localPortfolio] : localPortfolio.filter(w => w.category === manageFilter);
                const movedItem = filtered.splice(adjustedOld, 1)[0];
                filtered.splice(adjustedNew, 0, movedItem);
                if (manageFilter === 'ALL') { setLocalPortfolio(filtered); } else {
                    const newLocal = [...localPortfolio]; const originalIndices = [];
                    localPortfolio.forEach((w, i) => { if (w.category === manageFilter) originalIndices.push(i); });
                    filtered.forEach((w, i) => { newLocal[originalIndices[i]] = w; });
                    setLocalPortfolio(newLocal);
                }
                setHasOrderChanged(true);
            };


            const handleMediaSortEnd = (oldIdx, newIdx) => {
                setItemData(prev => { const newMedia = [...prev.media]; const [moved] = newMedia.splice(oldIdx, 1); newMedia.splice(newIdx, 0, moved); return { ...prev, media: newMedia }; });
            };

            const saveGlobalSortOrder = async () => {
                if (localPortfolio.some(item => item.id.toString().startsWith('sample_'))) { setGlobalNotification({ message: 'サンプルが含まれているため保存できません。', type: 'error' }); return; }
                try {
                    const batch = writeBatch(db);
                    localPortfolio.forEach((item, index) => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'works', item.id), { order: index }); });
                    await batch.commit(); setHasOrderChanged(false); setGlobalNotification({ message: '順番を保存しました！', type: 'success' });
                } catch (err) { setGlobalNotification({ message: '保存失敗', type: 'error' }); }
            };

            const toggleTag = (tag) => { setItemData(prev => { const newTags = prev.tags.includes(tag) ? prev.tags.filter(t => t !== tag) : [...prev.tags, tag]; return { ...prev, tags: newTags }; }); };
            const updateMedia = (index, field, value) => { const newMedia = [...itemData.media]; newMedia[index][field] = value; setItemData({ ...itemData, media: newMedia }); };
            const addMediaField = () => setItemData({ ...itemData, media: [...itemData.media, { type: 'image', url: '' }] });
            const removeMediaField = (index) => setItemData({ ...itemData, media: itemData.media.filter((_, i) => i !== index) });

            const currentCat = dynamicCategories.find(c => c.name.replace('■ ', '') === itemData.category);
            const availableTags = currentCat ? [...(currentCat.basePrices||[]).map(p => p.label), ...(currentCat.options||[]).map(p => p.label), ...(currentCat.otherOptions ? currentCat.otherOptions.map(p => p.label) : [])] : [];

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <form onSubmit={handleLogin} className="glass p-8 rounded-3xl w-full max-w-xs shadow-xl relative flex flex-col items-center gap-5">
                            <button type="button" onClick={() => changePage(prevPage)} className="absolute top-4 left-4 p-2 rounded-full text-slate-400 hover:bg-slate-100 hover:text-sky-500 transition-all z-10">
                                <Icon name="chevronLeft" size={20}/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-700">管理者ログイン</h2>
                            <input type="password" placeholder="Password" className="w-full p-3 rounded-xl border border-slate-200 outline-none focus:border-sky-300" value={password} onChange={e => setPassword(e.target.value)} />
                            <button type="submit" className="w-full bg-sky-500 text-white p-3 rounded-xl font-bold shadow-md hover:bg-sky-400 transition-all">Login</button>
                        </form>
                    </div>
                );
            }

            const previewUrl = (itemData.media && itemData.media.length > 0 && itemData.media[0].url) ? (itemData.media[0].type === 'image' ? itemData.media[0].url : getYouTubeThumbnail(itemData.media[0].url)) : '';
            const scaleVal = itemData.thumbnailPosition?.scale ?? 100;
            const posX = itemData.thumbnailPosition?.x ?? 50;
            const posY = itemData.thumbnailPosition?.y ?? 50;

            const filteredLocalPortfolio = manageFilter === 'ALL' ? localPortfolio : localPortfolio.filter(w => w.category === manageFilter);
            const itemsPerPage = manageViewMode === 'list' ? 10 : 24;
            const totalPages = Math.ceil(filteredLocalPortfolio.length / itemsPerPage);
            const paginatedPortfolio = isSortMode ? filteredLocalPortfolio : filteredLocalPortfolio.slice((currentPageNum - 1) * itemsPerPage, currentPageNum * itemsPerPage);

            return (
                <div className="min-h-screen p-6 pt-8 pb-40 max-w-3xl mx-auto fade-in-up relative">
                    {activeTab === 'hub' ? (
                        <>
                            <div className="flex items-center mb-8">
                                <button onClick={() => changePage(prevPage)} className="bg-white/80 backdrop-blur-md p-2 rounded-full shadow-md text-slate-500 hover:text-sky-500 transition-all hover:scale-105 border border-slate-100 shrink-0"><Icon name="chevronLeft" size={22}/></button>
                                <h2 className="text-2xl font-black text-slate-700 flex-1 text-center mr-10">管理ページ</h2>
                            </div>
                            <div className="space-y-4">
                                {[
                                    { id: 'gallery', icon: 'image', label: 'ギャラリーの編集', desc: '作品の投稿・編集・並び替え' },
                                    { id: 'menu', icon: 'menu', label: 'メニューの編集', desc: 'カテゴリ・料金・オプション設定' },
                                    { id: 'contact', icon: 'send', label: 'コンタクトの編集', desc: '連絡先・テンプレート管理' },
                                ].map(item => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className="w-full bg-white/80 backdrop-blur-md p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 hover:bg-sky-50 hover:border-sky-200 hover:shadow-md transition-all text-left group">
                                        <div className="w-12 h-12 rounded-xl bg-sky-50 flex items-center justify-center text-sky-500 group-hover:bg-sky-100 transition-colors shrink-0">
                                            <Icon name={item.icon} size={22}/>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h3 className="font-bold text-slate-700 text-sm">{item.label}</h3>
                                            <p className="text-[11px] text-slate-400">{item.desc}</p>
                                        </div>
                                        <Icon name="chevronLeft" size={18} className="text-slate-300 rotate-180 shrink-0"/>
                                    </button>
                                ))}
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="flex items-center mb-8">
                                <button onClick={() => setActiveTab('hub')} className="bg-white/80 backdrop-blur-md p-2 rounded-full shadow-md text-slate-500 hover:text-sky-500 transition-all hover:scale-105 border border-slate-100 shrink-0"><Icon name="chevronLeft" size={22}/></button>
                                <h2 className="text-xl font-black text-slate-700 flex-1 text-center mr-10">{activeTab === 'gallery' ? 'ギャラリーの編集' : activeTab === 'menu' ? 'メニューの編集' : 'コンタクトの編集'}</h2>
                            </div>

                    {activeTab === 'gallery' && (
                        <div className="space-y-6">
                            <div className="flex gap-2 bg-slate-100 p-1.5 rounded-2xl w-full mb-6">
                                <button onClick={() => { setGalleryMode('create'); resetForm(); }} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all ${galleryMode === 'create' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}>{editingId ? '編集中...' : '新規投稿'}</button>
                                <button onClick={() => setGalleryMode('manage')} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all ${galleryMode === 'manage' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-500 hover:bg-slate-200'}`}>編集・一覧</button>
                            </div>

                            {galleryMode === 'create' ? (
                                <form onSubmit={handleSubmit} className="space-y-6 bg-white/80 p-6 md:p-8 rounded-[2rem] border border-white shadow-lg">
                                    <div className="text-center font-bold text-slate-700 mb-4">{editingId ? '作品情報の編集' : '新しい作品を投稿'}</div>
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-2">タイトル & テンプレート</label>
                                        <div className="flex flex-col gap-2 mb-3">
                                            <div className="flex gap-2 w-full">
                                                <select value={selectedTemplate} onChange={(e) => {
                                                    setSelectedTemplate(e.target.value);
                                                    if(e.target.value) setItemData({...itemData, title: e.target.value});
                                                }} className="text-xs text-slate-600 bg-slate-50 px-2 py-2 rounded-lg border border-slate-200 outline-none flex-1 min-w-0">
                                                    <option value="">過去のひな型を選択...</option>
                                                    {templates && templates.map((t,i)=><option key={i} value={t}>{t}</option>)}
                                                </select>
                                                <button type="button" onClick={() => {
                                                    if(!selectedTemplate) return alert("削除するひな型を選択してください");
                                                    if(window.confirm("選択中のひな型を削除しますか？")) {
                                                        const newTemplates = templates.filter(t => t !== selectedTemplate);
                                                        setTemplates(newTemplates);
                                                        localStorage.setItem('medaka_title_templates', JSON.stringify(newTemplates));
                                                        setSelectedTemplate('');
                                                    }
                                                }} className="text-xs text-red-400 font-bold bg-red-50 px-3 py-2 rounded-lg border border-red-100 hover:bg-red-100 transition-colors shrink-0" title="選択中のひな型を削除"><Icon name="trash" size={14}/></button>
                                            </div>
                                            <div className="flex gap-2 w-full">
                                                <input className="flex-1 p-3 rounded-xl border border-slate-200 focus:border-sky-300 focus:ring-2 focus:ring-sky-50 outline-none transition-all min-w-0" value={itemData.title} onChange={e => setItemData({...itemData, title: e.target.value})} required placeholder="作品タイトルを入力" />
                                            </div>
                                            <div className="flex gap-2 justify-end">
                                                <button type="button" onClick={applyTitleTemplate} className="px-3 py-2 bg-sky-50 text-sky-500 text-xs rounded-lg font-bold border border-sky-100 shadow-sm hover:bg-sky-100 transition-colors">カテゴリから自動生成</button>
                                                <button type="button" onClick={() => {
                                                    if(!itemData.title) return alert("タイトルを入力してください");
                                                    if(templates && templates.includes(itemData.title)) return alert("既に登録されています");
                                                    const newTemplates = [...(templates || []), itemData.title];
                                                    setTemplates(newTemplates);
                                                    localStorage.setItem('medaka_title_templates', JSON.stringify(newTemplates));
                                                    setGlobalNotification({message: '現在のタイトルをテンプレートに登録しました', type: 'success'});
                                                }} className="text-xs text-slate-500 font-bold bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">＋ 現在のタイトルを登録</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-2">カテゴリ（必須）</label>
                                        <select className="w-full p-3 rounded-xl border border-slate-200 bg-white focus:border-sky-300 outline-none" value={itemData.category} onChange={e => setItemData({...itemData, category: e.target.value, tags: []})}>
                                            <option value="">選択してください</option>
                                            {DEFAULT_CATEGORIES.filter(c => c.id !== 'skeb').map(c => <option key={c.id} value={c.name.replace('■ ', '')}>{c.name.replace('■ ', '')}</option>)}
                                        </select>
                                    </div>
                                    
                                    {availableTags.length > 0 && (
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-2">タグ（任意選択）</label>
                                            <div className="flex flex-wrap gap-2 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                                {availableTags.map(tag => (
                                                    <button type="button" key={tag} onClick={() => toggleTag(tag)} className={`text-[10px] px-3 py-1 rounded-full border transition-all ${itemData.tags.includes(tag) ? 'bg-sky-500 text-white border-sky-500 shadow-sm' : 'bg-white text-slate-500 border-slate-200 hover:border-sky-200'}`}>{tag}</button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-2">制作時間</label>
                                        <select className="w-full p-3 rounded-xl border border-slate-200 bg-white focus:border-sky-300 outline-none" value={itemData.time} onChange={e => setItemData({...itemData, time: e.target.value})}>
                                            {[...Array(100).keys()].map(i => <option key={i+1} value={`${i+1}h`}>{i+1}h</option>)}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-2">Focus Point</label>
                                        <textarea className="w-full p-3 rounded-xl border border-slate-200 h-24 focus:border-sky-300 outline-none" value={itemData.focus} onChange={e => setItemData({...itemData, focus: e.target.value})} />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-2">メディア (ドラッグで並び替え可)</label>
                                        <div className="space-y-3">
                                            <SortableList 
                                                items={itemData.media} 
                                                onSortEnd={handleMediaSortEnd} 
                                                className="space-y-2"
                                                renderItem={(m, idx) => (
                                                    <div key={`media-${idx}`} className="flex flex-col sm:flex-row gap-2 bg-white p-3 rounded-xl border border-slate-200 shadow-sm relative pr-8 sm:pr-3">
                                                        <div className="flex items-center gap-2">
                                                            <div className="drag-handle p-1 text-slate-300 hover:text-sky-500 cursor-grab touch-none shrink-0">
                                                                <Icon name="grip" size={16} />
                                                            </div>
                                                            <select className="p-2 rounded-lg border border-slate-200 text-xs bg-slate-50 shrink-0 outline-none" value={m.type} onChange={e => updateMedia(idx, 'type', e.target.value)}>
                                                                <option value="image">画像</option>
                                                                <option value="youtube">YouTube</option>
                                                            </select>
                                                        </div>
                                                        <input className="flex-1 w-full p-2 rounded-lg border border-slate-200 text-xs bg-slate-50 min-w-0 outline-none focus:border-sky-300" placeholder="URL" value={m.url} onChange={e => updateMedia(idx, 'url', e.target.value)} />
                                                        {itemData.media && itemData.media.length > 1 && (
                                                            <button type="button" onClick={() => removeMediaField(idx)} className="absolute top-4 right-2 sm:static sm:top-auto sm:right-auto text-slate-300 hover:text-red-500 p-1 transition-colors" title="このURL枠を削除">
                                                                <Icon name="x" size={16}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                )}
                                            />
                                            <button type="button" onClick={addMediaField} className="text-xs text-sky-500 font-bold hover:underline bg-sky-50 px-3 py-2 rounded-lg mt-1 inline-block border border-sky-100 transition-colors">+ 枠を追加</button>
                                        </div>
                                    </div>
                                    
                                    {/* サムネイル位置調整 */}
                                    {previewUrl && (
                                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                            <label className="block text-xs font-bold text-slate-500 mb-3">サムネイル調整 (ズーム＆パン)</label>
                                            <div className="flex flex-col md:flex-row gap-6 items-start">
                                                <div className="w-32 h-32 rounded-xl overflow-hidden bg-white shadow-sm border border-slate-200 shrink-0 relative mx-auto md:mx-0">
                                                    <SmartThumbnail src={previewUrl} position={itemData.thumbnailPosition} className="w-full h-full" />
                                                    <div className="absolute inset-0 border-2 border-sky-400/30 pointer-events-none rounded-xl z-10 opacity-50"></div>
                                                    <div className="absolute top-1/2 left-0 w-full h-[1px] bg-sky-400/30 pointer-events-none z-10"></div>
                                                    <div className="absolute left-1/2 top-0 w-[1px] h-full bg-sky-400/30 pointer-events-none z-10"></div>
                                                </div>
                                                <div className="flex-1 space-y-4 pt-2 w-full">
                                                    <div>
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>左右位置 (Left ↔ Right) : {posX}%</span></div>
                                                        <input type="range" min="0" max="100" value={posX} onChange={(e) => setItemData({...itemData, thumbnailPosition: {...itemData.thumbnailPosition, x: parseInt(e.target.value)}})} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                                    </div>
                                                    <div>
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>上下位置 (Top ↔ Bottom) : {posY}%</span></div>
                                                        <input type="range" min="0" max="100" value={posY} onChange={(e) => setItemData({...itemData, thumbnailPosition: {...itemData.thumbnailPosition, y: parseInt(e.target.value)}})} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                                    </div>
                                                    <div>
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>拡大 (Zoom) : {scaleVal}%</span></div>
                                                        <input type="range" min="100" max="500" value={scaleVal} onChange={(e) => setItemData({...itemData, thumbnailPosition: {...itemData.thumbnailPosition, scale: parseInt(e.target.value)}})} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex gap-4 pt-4">
                                        {editingId && <button type="button" onClick={resetForm} className="flex-1 bg-slate-200 text-slate-600 p-4 rounded-2xl font-bold hover:bg-slate-300 transition-colors">キャンセル</button>}
                                        <button type="submit" className="flex-1 bg-slate-800 text-white p-4 rounded-2xl font-bold shadow-lg hover:bg-slate-700 transition-all">{editingId ? '更新する' : '投稿する'}</button>
                                    </div>
                                    {editingId && (
                                        <button type="button" onClick={() => handleDelete(editingId)} className="w-full mt-2 py-2 text-[11px] font-bold text-red-300 hover:text-red-500 transition-colors">
                                            この作品を削除する
                                        </button>
                                    )}
                                </form>
                            ) : (
                                <div className="space-y-4">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                        <div className="flex items-center gap-2 w-full sm:w-auto">
                                            <select value={manageFilter} onChange={e => setManageFilter(e.target.value)} className="p-2.5 border border-slate-200 rounded-xl text-xs font-bold text-slate-600 bg-white shadow-sm flex-1 sm:flex-none outline-none focus:border-sky-300">
                                                <option value="ALL">すべてのカテゴリ</option>
                                                {DEFAULT_CATEGORIES.filter(c=>c.id!=='skeb').map(c => <option key={c.id} value={c.name.replace('■ ', '')}>{c.name.replace('■ ', '')}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex items-center gap-2 w-full sm:w-auto bg-white p-1.5 rounded-xl shadow-sm border border-slate-100">
                                            <button onClick={() => setManageViewMode('list')} className={`p-2 rounded-lg transition-colors ${manageViewMode==='list'?'bg-sky-100 text-sky-600':'text-slate-400 hover:bg-slate-50'}`}><Icon name="menu" size={16}/></button>
                                            <button onClick={() => setManageViewMode('grid')} className={`p-2 rounded-lg transition-colors ${manageViewMode==='grid'?'bg-sky-100 text-sky-600':'text-slate-400 hover:bg-slate-50'}`}><Icon name="image" size={16}/></button>
                                            <div className="w-[1px] h-6 bg-slate-200 mx-1"></div>
                                            <button onClick={() => setIsSortMode(!isSortMode)} className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-bold transition-colors ${isSortMode ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100 border border-slate-200'}`}>
                                                <Icon name="grip" size={14}/> 並び替え {isSortMode ? 'ON' : 'OFF'}
                                            </button>
                                        </div>
                                    </div>

                                    {(!filteredLocalPortfolio || filteredLocalPortfolio.length === 0) ? (
                                        <div className="text-center py-10 text-slate-400 text-sm bg-white/50 rounded-2xl border border-dashed border-slate-300">
                                            該当する作品がありません。
                                        </div>
                                    ) : (
                                        <>
                                            {isSortMode && (
                                                <div className="bg-sky-50 p-4 rounded-2xl text-xs text-sky-800 flex items-start gap-2 border border-sky-100 mb-4 shadow-sm">
                                                    <Icon name="info" size={16} className="mt-0.5 shrink-0"/>
                                                    <div>
                                                        <p className="font-bold mb-1">並び替えモード</p>
                                                        <p><Icon name="grip" size={12} className="inline mr-1"/>ハンドルをドラッグして順番を入れ替えてください。完了したら画面下の「保存」を押してください。</p>
                                                    </div>
                                                </div>
                                            )}
                                            <SortableList 
                                                key={`gallery-${manageViewMode}`}
                                                items={paginatedPortfolio} 
                                                onSortEnd={handleSortEnd} 
                                                disabled={!isSortMode}
                                                className={manageViewMode === 'list' ? "space-y-3" : "flex flex-wrap gap-3 md:gap-4"}
                                                renderItem={(work, index) => (
                                                    manageViewMode === 'list' ? (
                                                        <div key={`work-${work.id}`} className={`w-full bg-white p-3 rounded-2xl flex gap-3 sm:gap-4 items-center shadow-sm border ${isSortMode ? 'border-sky-200 ring-1 ring-sky-50' : 'border-slate-100'}`}>
                                                            {isSortMode && (
                                                                <div className="drag-handle p-1 sm:p-2 text-slate-300 hover:text-sky-500 cursor-grab touch-none shrink-0">
                                                                    <Icon name="grip" size={16} className="sm:hidden" /><Icon name="grip" size={20} className="hidden sm:block" />
                                                                </div>
                                                            )}
                                                            <div className="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden shrink-0 pointer-events-none">
                                                                <SmartThumbnail src={work.media && work.media.length > 0 ? (work.media[0].type === 'image' ? work.media[0].url : getYouTubeThumbnail(work.media[0].url)) : ''} position={work.thumbnailPosition} className="w-full h-full" />
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <h4 className="font-bold text-slate-700 text-xs sm:text-sm truncate">{work.title}</h4>
                                                                <p className="text-[10px] text-slate-400 truncate">{work.category}</p>
                                                            </div>
                                                            {!isSortMode && (
                                                                <button onClick={() => handleEditClick(work)} className="p-2 rounded-lg transition-colors text-sky-500 bg-sky-50 hover:bg-sky-100 shrink-0"><Icon name="edit" size={16}/></button>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <div key={`work-${work.id}`} className={`aspect-square bg-white rounded-2xl overflow-hidden shadow-sm border relative group w-[calc(50%-6px)] sm:w-[calc(25%-12px)] ${isSortMode ? 'border-sky-200 ring-1 ring-sky-50' : 'border-slate-100'}`}>
                                                            <SmartThumbnail src={work.media && work.media.length > 0 ? (work.media[0].type === 'image' ? work.media[0].url : getYouTubeThumbnail(work.media[0].url)) : ''} position={work.thumbnailPosition} className="w-full h-full pointer-events-none" />
                                                            {!isSortMode && (
                                                                <button onClick={() => handleEditClick(work)} className="absolute top-1.5 right-1.5 sm:top-2 sm:right-2 p-1 sm:p-1.5 bg-white/80 rounded-md text-sky-500 hover:text-sky-600 backdrop-blur-sm shadow-sm z-30 transition-colors">
                                                                    <Icon name="edit" size={14} className="sm:hidden"/><Icon name="edit" size={18} className="hidden sm:block"/>
                                                                </button>
                                                            )}
                                                            {isSortMode && (
                                                                <div className="absolute top-1.5 left-1.5 sm:top-2 sm:left-2 p-1 sm:p-1.5 bg-white/80 rounded-md text-slate-400 hover:text-sky-500 backdrop-blur-sm shadow-sm drag-handle cursor-grab touch-none z-30">
                                                                    <Icon name="grip" size={14} className="sm:hidden"/><Icon name="grip" size={18} className="hidden sm:block"/>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )
                                                )}
                                            />
                                            
                                            {!isSortMode && totalPages > 1 && (
                                                <div className="flex justify-center items-center gap-4 mt-8 mb-4">
                                                    <button disabled={currentPageNum === 1} onClick={() => setCurrentPageNum(p => p - 1)} className="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-500 disabled:opacity-30 hover:bg-slate-50 shadow-sm transition-all"><Icon name="chevronLeft" size={20}/></button>
                                                    <span className="text-sm font-bold text-slate-500">{currentPageNum} <span className="text-slate-300 mx-1">/</span> {totalPages}</span>
                                                    <button disabled={currentPageNum === totalPages} onClick={() => setCurrentPageNum(p => p + 1)} className="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-500 disabled:opacity-30 hover:bg-slate-50 shadow-sm transition-all"><Icon name="chevronLeft" size={20} className="rotate-180"/></button>
                                                </div>
                                            )}
                                        </>
                                    )}
                                    
                                    <div className={`fixed bottom-6 left-0 right-0 z-[200] flex justify-center transition-all duration-500 px-4 ${hasOrderChanged ? 'translate-y-0 opacity-100' : 'translate-y-24 opacity-0 pointer-events-none'}`}>
                                        <button onClick={saveGlobalSortOrder} className="w-full max-w-sm bg-slate-800 text-white py-4 rounded-full font-bold shadow-2xl hover:bg-slate-700 transition-all flex items-center justify-center gap-2">
                                            <Icon name="check" size={18} /> 新しい順序を保存して終了
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'menu' && (
                        <div className="bg-white/80 p-6 md:p-8 rounded-[2rem] border border-white shadow-lg space-y-8">
                            <div className="text-center font-bold text-slate-700 mb-6">メニュー表の編集</div>
                            <p className="text-[11px] text-slate-500 mb-4 bg-sky-50 p-4 rounded-xl border border-sky-100">各メニューの料金やセール設定、表示するサンプル画像を設定できます。編集後、各カテゴリごとの「設定を反映する」ボタンを押してください。<br/>※ここで追加した料金項目は、新規投稿画面の「タグ」候補にも自動的に反映されます。</p>
                            
                            <div className="space-y-8">
                                {DEFAULT_CATEGORIES.filter(c => c.id !== 'skeb').map(cat => {
                                    const curPricing = settingsData.categoryPricing?.[cat.id] || { basePrices: [...(cat.basePrices||[])], options: [...(cat.options||[])], otherOptions: [...(cat.otherOptions||[])], optionNote: cat.optionNote||"" };
                                    const availableWorksForSample = localPortfolio.filter(w => w.category === cat.name || w.category === cat.name.replace('■ ', ''));
                                    const currentSamples = settingsData.categorySamples?.[cat.id] || [];
                                    
                                    return (
                                        <div key={cat.id} className="border border-slate-200 rounded-2xl bg-white relative overflow-hidden">
                                            <button type="button" onClick={() => setOpenMenuEditIds(prev => prev.includes(cat.id) ? prev.filter(id => id !== cat.id) : [...prev, cat.id])} className="w-full p-4 sm:p-6 flex items-center justify-between text-left hover:bg-slate-50 transition-colors">
                                                <h3 className="font-black text-sky-600 flex items-center gap-2"><Icon name="edit" size={18}/> {cat.name}</h3>
                                                <Icon name="chevronDown" size={20} className={`text-slate-400 transition-transform duration-300 ${openMenuEditIds.includes(cat.id) ? 'rotate-180' : ''}`}/>
                                            </button>
                                            
                                            {openMenuEditIds.includes(cat.id) && (
                                            <div className="px-4 sm:px-6 pb-4 sm:pb-6">
                                            
                                            <div className="mb-8">
                                                <h4 className="text-[11px] font-bold text-slate-500 mb-3 flex items-center gap-1"><Icon name="image" size={14}/> メニューに表示する作例（最大3件）</h4>
                                                <div className="flex flex-col sm:flex-row gap-2 mb-3">
                                                    <select id={`sampleSelect_${cat.id}`} className="text-xs border border-slate-200 rounded-lg p-2 flex-1 outline-none focus:border-sky-300 bg-slate-50">
                                                        <option value="">ギャラリーから作品を選ぶ...</option>
                                                        {availableWorksForSample.map(w => <option key={w.id} value={w.id}>{w.title}</option>)}
                                                    </select>
                                                    <button type="button" onClick={() => {
                                                        const selectEl = document.getElementById(`sampleSelect_${cat.id}`);
                                                        if(selectEl && selectEl.value) {
                                                            if(currentSamples.includes(selectEl.value)) return alert("追加済みです");
                                                            if(currentSamples.length >= 3) return alert("最大3件までです");
                                                            updateCategorySamples(cat.id, [...currentSamples, selectEl.value]);
                                                            selectEl.value = "";
                                                        }
                                                    }} disabled={currentSamples.length >= 3} className={`px-4 py-2 text-xs rounded-lg font-bold transition-colors whitespace-nowrap ${currentSamples.length >= 3 ? 'bg-slate-50 text-slate-300 cursor-not-allowed' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>{currentSamples.length >= 3 ? '上限' : '追加'}</button>
                                                </div>
                                                {currentSamples.length > 0 && (
                                                    <SortableList 
                                                        items={currentSamples}
                                                        onSortEnd={(oldIdx, newIdx) => {
                                                            const newOrder = [...currentSamples];
                                                            const [moved] = newOrder.splice(oldIdx, 1);
                                                            newOrder.splice(newIdx, 0, moved);
                                                            updateCategorySamples(cat.id, newOrder);
                                                        }}
                                                        className="flex gap-3 flex-wrap"
                                                        renderItem={(workId, idx) => {
                                                            const w = portfolio.find(p => p.id === workId);
                                                            if(!w) return null;
                                                            return (
                                                                <div key={`sample-${idx}`} className="relative w-20 h-20 sm:w-28 sm:h-28 rounded-xl bg-slate-100 overflow-hidden border border-slate-200 shadow-sm shrink-0 group">
                                                                    <SmartThumbnail src={w.media && w.media[0] ? w.media[0].url : ''} position={w.thumbnailPosition} className="w-full h-full" />
                                                                    <div className="drag-handle absolute top-1 left-1 p-0.5 bg-white/80 rounded text-slate-400 hover:text-sky-500 cursor-grab backdrop-blur-sm z-10"><Icon name="grip" size={12}/></div>
                                                                    <button type="button" onClick={() => updateCategorySamples(cat.id, currentSamples.filter(id => id !== workId))} className="absolute top-1 right-1 p-0.5 bg-white/80 rounded text-slate-400 hover:text-red-400 backdrop-blur-sm z-10"><Icon name="x" size={12}/></button>
                                                                </div>
                                                            );
                                                        }}
                                                    />
                                                )}
                                            </div>

                                            <div className="mb-8">
                                                <h4 className="text-[11px] font-bold text-slate-500 mb-3 flex items-center gap-1"><Icon name="star" size={14}/> 基本料金・設定</h4>
                                                <SortableList
                                                    items={curPricing.basePrices}
                                                    onSortEnd={(oldIdx, newIdx) => handlePriceSortEnd(cat.id, 'basePrices', oldIdx, newIdx)}
                                                    className="space-y-3 mb-2"
                                                    renderItem={(bp, i) => (
                                                        <div key={`bp-${i}`} className="flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-slate-50 p-3 rounded-xl border border-slate-100 relative">
                                                            <div className="flex items-center gap-2 w-full sm:w-auto sm:flex-1">
                                                                <div className="drag-handle p-1 text-slate-300 hover:text-sky-500 cursor-grab touch-none shrink-0">
                                                                    <Icon name="grip" size={16}/>
                                                                </div>
                                                                <input className="flex-1 min-w-0 w-full p-2 text-xs border border-slate-200 rounded-lg outline-none focus:border-sky-300" value={bp.label} onChange={e => updatePricing(cat.id, 'basePrices', i, 'label', e.target.value)} placeholder="項目名" />
                                                                <input className="w-24 shrink-0 p-2 text-xs border border-slate-200 rounded-lg font-bold text-sky-600 outline-none focus:border-sky-300" value={bp.price} onChange={e => updatePricing(cat.id, 'basePrices', i, 'price', e.target.value)} placeholder="¥0〜" />
                                                            </div>
                                                            <div className="flex flex-wrap gap-2 items-center w-full sm:w-auto mt-1 sm:mt-0 justify-end pl-8 sm:pl-0">
                                                                <label className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1.5 rounded-lg border cursor-pointer transition-colors ${bp.isSale ? 'bg-rose-50 text-rose-500 border-rose-200' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                                    <input type="checkbox" checked={bp.isSale || false} onChange={e => updatePricing(cat.id, 'basePrices', i, 'isSale', e.target.checked)} className="accent-rose-500" />
                                                                    SALE
                                                                </label>
                                                                {bp.isSale && (
                                                                    <input className="w-20 min-w-0 p-2 text-xs border rounded-lg font-bold text-rose-500 border-rose-200 bg-white outline-none focus:border-rose-400" value={bp.salePrice || ''} onChange={e => updatePricing(cat.id, 'basePrices', i, 'salePrice', e.target.value)} placeholder="¥割引後" />
                                                                )}
                                                                <label className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1.5 rounded-lg border cursor-pointer transition-colors ml-auto sm:ml-0 ${bp.isStopped ? 'bg-slate-200 text-slate-600 border-slate-300' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                                    <input type="checkbox" checked={bp.isStopped || false} onChange={e => updatePricing(cat.id, 'basePrices', i, 'isStopped', e.target.checked)} className="accent-slate-500" />
                                                                    受付停止
                                                                </label>
                                                                <button type="button" onClick={() => removePricingItem(cat.id, 'basePrices', i)} className="text-slate-300 hover:text-rose-400 p-1 ml-1"><Icon name="x" size={16}/></button>
                                                            </div>
                                                        </div>
                                                    )}
                                                />
                                                <button type="button" onClick={() => addPricingItem(cat.id, 'basePrices')} className="text-[10px] text-sky-500 font-bold hover:underline">+ 基本料金を追加</button>
                                            </div>

                                            <div className="mb-8">
                                                <h4 className="text-[11px] font-bold text-slate-500 mb-3 flex items-center gap-1"><Icon name="star" size={14}/> オプション料金</h4>
                                                <SortableList
                                                    items={curPricing.options}
                                                    onSortEnd={(oldIdx, newIdx) => handlePriceSortEnd(cat.id, 'options', oldIdx, newIdx)}
                                                    className="space-y-3 mb-2"
                                                    renderItem={(opt, i) => (
                                                        <div key={`opt-${i}`} className="flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-slate-50 p-3 rounded-xl border border-slate-100 relative">
                                                            <div className="flex items-center gap-2 w-full sm:w-auto sm:flex-1">
                                                                <div className="drag-handle p-1 text-slate-300 hover:text-sky-500 cursor-grab touch-none shrink-0">
                                                                    <Icon name="grip" size={16}/>
                                                                </div>
                                                                <input className="flex-1 min-w-0 w-full p-2 text-xs border border-slate-200 rounded-lg outline-none focus:border-indigo-300" value={opt.label} onChange={e => updatePricing(cat.id, 'options', i, 'label', e.target.value)} placeholder="項目名" />
                                                                <input className="w-24 shrink-0 p-2 text-xs border border-slate-200 rounded-lg font-bold text-indigo-500 outline-none focus:border-indigo-300" value={opt.price} onChange={e => updatePricing(cat.id, 'options', i, 'price', e.target.value)} placeholder="＋¥0〜" />
                                                            </div>
                                                            <div className="flex flex-wrap gap-2 items-center w-full sm:w-auto mt-1 sm:mt-0 justify-end pl-8 sm:pl-0">
                                                                <label className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1.5 rounded-lg border cursor-pointer transition-colors ${opt.isSale ? 'bg-rose-50 text-rose-500 border-rose-200' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                                    <input type="checkbox" checked={opt.isSale || false} onChange={e => updatePricing(cat.id, 'options', i, 'isSale', e.target.checked)} className="accent-rose-500" />
                                                                    SALE
                                                                </label>
                                                                {opt.isSale && (
                                                                    <input className="w-20 min-w-0 p-2 text-xs border rounded-lg font-bold text-rose-500 border-rose-200 bg-white outline-none focus:border-rose-400" value={opt.salePrice || ''} onChange={e => updatePricing(cat.id, 'options', i, 'salePrice', e.target.value)} placeholder="¥割引後" />
                                                                )}
                                                                <label className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1.5 rounded-lg border cursor-pointer transition-colors ml-auto sm:ml-0 ${opt.isStopped ? 'bg-slate-200 text-slate-600 border-slate-300' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                                    <input type="checkbox" checked={opt.isStopped || false} onChange={e => updatePricing(cat.id, 'options', i, 'isStopped', e.target.checked)} className="accent-slate-500" />
                                                                    受付停止
                                                                </label>
                                                                <button type="button" onClick={() => removePricingItem(cat.id, 'options', i)} className="text-slate-300 hover:text-rose-400 p-1 ml-1"><Icon name="x" size={16}/></button>
                                                            </div>
                                                        </div>
                                                    )}
                                                />
                                                <button type="button" onClick={() => addPricingItem(cat.id, 'options')} className="text-[10px] text-indigo-500 font-bold hover:underline">+ オプションを追加</button>
                                            </div>

                                            <div className="mb-8">
                                                <h4 className="text-[11px] font-bold text-slate-500 mb-3 flex items-center gap-1"><Icon name="star" size={14}/> その他オプション</h4>
                                                <SortableList
                                                    items={curPricing.otherOptions}
                                                    onSortEnd={(oldIdx, newIdx) => handlePriceSortEnd(cat.id, 'otherOptions', oldIdx, newIdx)}
                                                    className="space-y-3 mb-2"
                                                    renderItem={(opt, i) => (
                                                        <div key={`other-${i}`} className="flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-slate-50 p-3 rounded-xl border border-slate-100 relative">
                                                            <div className="flex items-center gap-2 w-full sm:w-auto sm:flex-1">
                                                                <div className="drag-handle p-1 text-slate-300 hover:text-sky-500 cursor-grab touch-none shrink-0">
                                                                    <Icon name="grip" size={16}/>
                                                                </div>
                                                                <input className="flex-1 min-w-0 w-full p-2 text-xs border border-slate-200 rounded-lg outline-none focus:border-pink-300" value={opt.label} onChange={e => updatePricing(cat.id, 'otherOptions', i, 'label', e.target.value)} placeholder="項目名" />
                                                                <input className="w-24 shrink-0 p-2 text-xs border border-slate-200 rounded-lg font-bold text-pink-500 outline-none focus:border-pink-300" value={opt.price} onChange={e => updatePricing(cat.id, 'otherOptions', i, 'price', e.target.value)} placeholder="要相談 など" />
                                                            </div>
                                                            <div className="flex flex-wrap gap-2 items-center w-full sm:w-auto mt-1 sm:mt-0 justify-end pl-8 sm:pl-0">
                                                                <label className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1.5 rounded-lg border cursor-pointer transition-colors ${opt.isSale ? 'bg-rose-50 text-rose-500 border-rose-200' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                                    <input type="checkbox" checked={opt.isSale || false} onChange={e => updatePricing(cat.id, 'otherOptions', i, 'isSale', e.target.checked)} className="accent-rose-500" />
                                                                    SALE
                                                                </label>
                                                                {opt.isSale && (
                                                                    <input className="w-20 min-w-0 p-2 text-xs border rounded-lg font-bold text-rose-500 border-rose-200 bg-white outline-none focus:border-rose-400" value={opt.salePrice || ''} onChange={e => updatePricing(cat.id, 'otherOptions', i, 'salePrice', e.target.value)} placeholder="¥割引後" />
                                                                )}
                                                                <label className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1.5 rounded-lg border cursor-pointer transition-colors ml-auto sm:ml-0 ${opt.isStopped ? 'bg-slate-200 text-slate-600 border-slate-300' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                                    <input type="checkbox" checked={opt.isStopped || false} onChange={e => updatePricing(cat.id, 'otherOptions', i, 'isStopped', e.target.checked)} className="accent-slate-500" />
                                                                    受付停止
                                                                </label>
                                                                <button type="button" onClick={() => removePricingItem(cat.id, 'otherOptions', i)} className="text-slate-300 hover:text-rose-400 p-1 ml-1"><Icon name="x" size={16}/></button>
                                                            </div>
                                                        </div>
                                                    )}
                                                />
                                                <button type="button" onClick={() => addPricingItem(cat.id, 'otherOptions')} className="text-[10px] text-pink-500 font-bold hover:underline">+ その他オプションを追加</button>
                                            </div>

                                            <div className="mb-6">
                                                <h4 className="text-[11px] font-bold text-slate-500 mb-3 flex items-center gap-1"><Icon name="edit" size={14}/> メニュー下部の備考欄</h4>
                                                <textarea 
                                                    className="w-full p-3 text-xs border border-slate-200 rounded-xl outline-none focus:border-sky-300 leading-relaxed"
                                                    rows="3"
                                                    placeholder="備考や注釈を入力（空欄の場合は表示されません）"
                                                    value={curPricing.optionNote || ''}
                                                    onChange={e => {
                                                        setSettingsData(prev => {
                                                            const newPricing = { ...prev.categoryPricing };
                                                            if (!newPricing[cat.id]) {
                                                                const defaultCat = DEFAULT_CATEGORIES.find(c => c.id === cat.id);
                                                                newPricing[cat.id] = { basePrices: JSON.parse(JSON.stringify(defaultCat.basePrices||[])), options: JSON.parse(JSON.stringify(defaultCat.options||[])), otherOptions: JSON.parse(JSON.stringify(defaultCat.otherOptions||[])), optionNote: defaultCat.optionNote||"" };
                                                            }
                                                            newPricing[cat.id].optionNote = e.target.value;
                                                            return { ...prev, categoryPricing: newPricing };
                                                        });
                                                    }}
                                                />
                                            </div>
                                            
                                            <div className="flex justify-end mt-4 pt-4 border-t border-slate-100 gap-2 flex-wrap">
                                                <button type="button" onClick={() => handleResetCategoryPricing(cat.id)} className="px-3 py-2 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-100 transition-all border border-slate-200">初期状態に戻す</button>
                                                <button onClick={handleSaveSettings} className="bg-sky-500 text-white px-6 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-sky-400 transition-all flex items-center gap-2"><Icon name="check" size={16}/> 設定を反映する</button>
                                            </div>

                                            <button 
                                                type="button"
                                                onClick={() => setOpenMenuEditIds(prev => prev.filter(id => id !== cat.id))}
                                                className="w-full flex items-center justify-center pt-2 mt-2 text-slate-300 hover:text-sky-500 transition-colors"
                                            >
                                                <Icon name="chevronDown" size={20} className="rotate-180" />
                                            </button>
                                            </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {activeTab === 'contact' && (
                        <form onSubmit={handleSaveSettings} className="bg-white/80 p-6 md:p-8 rounded-[2rem] border border-white shadow-lg space-y-6">
                            <div className="text-center font-bold text-slate-700 mb-4">コンタクトページの設定</div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-2">現在の受付状況（着手予定時期など）</label>
                                <input className="w-full p-3 rounded-xl border border-slate-200 focus:border-sky-300 outline-none transition-all" placeholder="例: 2026年3月頃" value={settingsData.acceptStatus || ''} onChange={e => setSettingsData({...settingsData, acceptStatus: e.target.value})} required />
                                <p className="text-[10px] text-slate-400 mt-2">入力したテキストがCONTACTページの「現在、〇〇着手の案件を受付中です」に反映されます。</p>
                            </div>
                            <div className="pt-4 border-t border-slate-100">
                                <button type="submit" className="w-full bg-slate-800 text-white p-4 rounded-2xl font-bold shadow-lg hover:bg-slate-700 transition-all">設定を反映する</button>
                            </div>
                        </form>
                    )}
                        </>
                    )}
                </div>
            );
        };


        const App = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [prevPage, setPrevPage] = useState('home'); 
            const [user, setUser] = useState(null);
            const [portfolio, setPortfolio] = useState([]);
            const [siteSettings, setSiteSettings] = useState({ acceptStatus: '2026年3月頃', categoryPricing: {}, categorySamples: {} });
            const [openMenuId, setOpenMenuId] = useState(null);
            const [selectedWork, setSelectedWork] = useState(null);
            const [workImgIndex, setWorkImgIndex] = useState(0);
            const [fullScreenUrl, setFullScreenUrl] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSent, setIsSent] = useState(false);
            const [copied, setCopied] = useState(false);
            const [emailCopied, setEmailCopied] = useState(false);
            const [isProfileExpanded, setIsProfileExpanded] = useState(false);
            
            const [filterCategory, setFilterCategory] = useState('ALL');

            const profileIconUrl = "https://i.imgur.com/Z8QWPQm.png";

            // 通知用Toastのステート
            const [globalNotification, setGlobalNotification] = useState(null);

            // ユーザー向け表示用
            const displayWorks = useMemo(() => {
                return portfolio.length > 0 ? portfolio : SAMPLE_WORKS;
            }, [portfolio]);

            // Firestoreの料金設定とデフォルトカテゴリをマージする処理
            const dynamicCategories = useMemo(() => {
                return DEFAULT_CATEGORIES.map(cat => {
                    const customPricing = siteSettings.categoryPricing?.[cat.id];
                    const sampleWorks = siteSettings.categorySamples?.[cat.id] || [];
                    
                    if (!customPricing) return { ...cat, sampleWorks };

                    // 最低金額の自動計算
                    let calculatedPrice = cat.price;
                    let isSaleActive = false;
                    let calculatedSalePrice = null;

                    if (customPricing.basePrices && customPricing.basePrices.length > 0) {
                        let minItem = null;
                        let minEffectivePrice = Infinity;
                        
                        customPricing.basePrices.forEach(bp => {
                            const effectivePriceStr = (bp.isSale && bp.salePrice) ? bp.salePrice : bp.price;
                            const val = parseInt(effectivePriceStr.replace(/[^0-9]/g, ''), 10);
                            if(!isNaN(val) && val < minEffectivePrice) {
                                minEffectivePrice = val;
                                minItem = bp;
                            }
                        });
                        
                        if (minItem) {
                            if (minItem.isSale && minItem.salePrice) {
                                isSaleActive = true;
                                calculatedPrice = parseInt(minItem.price.replace(/[^0-9]/g, ''), 10).toLocaleString();
                                calculatedSalePrice = minEffectivePrice.toLocaleString();
                            } else {
                                isSaleActive = false;
                                calculatedPrice = minEffectivePrice.toLocaleString();
                            }
                        }
                    }

                    return {
                        ...cat,
                        price: calculatedPrice,
                        isSale: isSaleActive,
                        salePrice: calculatedSalePrice,
                        basePrices: customPricing.basePrices || cat.basePrices,
                        options: customPricing.options || cat.options,
                        otherOptions: customPricing.otherOptions || cat.otherOptions,
                        optionNote: customPricing.optionNote ?? cat.optionNote,
                        sampleWorks: sampleWorks
                    };
                });
            }, [siteSettings]);

            const categoryTabs = useMemo(() => {
                return ['ALL', ...dynamicCategories.filter(c => c.id !== 'skeb').map(c => c.name.replace('■ ', ''))];
            }, [dynamicCategories]);

            const filteredWorks = useMemo(() => {
                if (filterCategory === 'ALL') return displayWorks;
                return displayWorks.filter(w => w.category === filterCategory);
            }, [displayWorks, filterCategory]);

            // セールが一つでも有効か判定
            const isAnySaleActive = useMemo(() => {
                if(!siteSettings?.categoryPricing) return false;
                for(const catId in siteSettings.categoryPricing) {
                    const catPricing = siteSettings.categoryPricing[catId];
                    if(catPricing.basePrices && catPricing.basePrices.some(bp => bp.isSale)) return true;
                }
                return false;
            }, [siteSettings]);

            useEffect(() => {
                const initAuth = async () => {
                    if (!auth) {
                        setPortfolio([]); 
                        setLoading(false);
                        return;
                    }
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { 
                        console.error("Auth Error:", e);
                    } finally {
                        setLoading(false); 
                    }
                };
                initAuth();
                if (auth) {
                    const unsubscribe = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!db) return;
                
                // 作品データの購読
                const qWorks = collection(db, 'artifacts', appId, 'public', 'data', 'works');
                const unsubWorks = onSnapshot(qWorks, (snapshot) => {
                    const items = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (items.length > 0) {
                        items.sort((a, b) => {
                            if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
                            return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                        });
                        setPortfolio(items);
                    } else {
                        setPortfolio([]);
                    }
                }, (err) => {
                    console.error("Snapshot Works Error:", err);
                    setPortfolio([]);
                });

                // サイト設定の購読
                const refSettings = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'general');
                const unsubSettings = onSnapshot(refSettings, (snapshot) => {
                    if (snapshot.exists() && snapshot.data()) {
                        setSiteSettings(prev => ({ ...prev, ...snapshot.data() }));
                    }
                }, (err) => {
                    console.error("Snapshot Settings Error:", err);
                });

                return () => { unsubWorks(); unsubSettings(); };
            }, [user]);

            const changePage = (id) => {
                setPrevPage(currentPage); // 遷移前のページを記憶
                setCurrentPage(id);
                window.scrollTo(0, 0);
                setOpenMenuId(null);
                setIsSent(false); 
                setCopied(false);
                setEmailCopied(false);
                setFilterCategory('ALL');
                setIsProfileExpanded(false);
            };

            const handleContactSubmit = (e) => { e.preventDefault(); setIsSent(true); };
            
            const copyText = (text) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                document.body.appendChild(textarea);
                textarea.select();
                try { document.execCommand('copy'); return true; } 
                catch (err) { return false; } 
                finally { document.body.removeChild(textarea); }
            };

            const handleTemplateCopy = (text) => { if (copyText(text)) { setCopied(true); setTimeout(() => setCopied(false), 2000); } };
            const handleEmailCopy = () => { if (copyText('medapappa@gmail.com')) { setEmailCopied(true); setTimeout(() => setEmailCopied(false), 3000); } };

            const touchStartX = useRef(0);
            const touchEndX = useRef(0);
            
            const handleTouchStart = (e) => { touchStartX.current = e.changedTouches[0].screenX; };
            const handleTouchEnd = (e) => {
                touchEndX.current = e.changedTouches[0].screenX;
                handleSwipe();
            };
            
            const handleSwipe = () => {
                if (!selectedWork) return;
                const mediaLen = selectedWork.media ? selectedWork.media.length : (selectedWork.urls ? selectedWork.urls.length : 0);
                if (mediaLen <= 1) return;
                
                if (touchStartX.current - touchEndX.current > 50) {
                    setWorkImgIndex((prev) => (prev + 1) % mediaLen);
                }
                if (touchStartX.current - touchEndX.current < -50) {
                    setWorkImgIndex((prev) => (prev - 1 + mediaLen) % mediaLen);
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-sky-300 font-black animate-pulse bg-[#f0f9ff]">LOADING...</div>;

            if (currentPage === 'admin') return (
                <>
                    <AdminPage changePage={changePage} db={db} appId={appId} portfolio={portfolio} siteSettings={siteSettings} prevPage={prevPage} dynamicCategories={dynamicCategories} setGlobalNotification={setGlobalNotification} />
                    {globalNotification && <Toast message={globalNotification.message} type={globalNotification.type} onClose={() => setGlobalNotification(null)} />}
                </>
            );

            return (
                <div className={`relative min-h-screen ${isAnySaleActive ? 'pt-8' : ''}`}> {/* セールバナー分のパディングを確保 */}
                    <div className="fixed inset-0 bg-gradient-to-b from-sky-300 via-sky-100 to-sky-50 -z-10"></div>
                    <Bubbles />

                    {/* 固定ヘッダー（セール開催中）波リボンデザイン */}
                    {isAnySaleActive && (
                        <div className="fixed top-0 left-0 w-full z-[200] animate-fade-in-down drop-shadow-md">
                            <div className="bg-rose-400/95 backdrop-blur-sm text-white py-2 flex justify-center items-center gap-2 relative">
                                <span className="animate-pulse flex items-center gap-2 text-[11px] font-bold tracking-widest cursor-pointer" onClick={() => changePage('menu')}>
                                    <Icon name="star" size={14} className="text-yellow-200" />
                                    期間限定 SALE開催中！ メニューをチェック
                                    <Icon name="star" size={14} className="text-yellow-200" />
                                </span>
                                <div className="absolute top-full left-0 w-full h-[6px] overflow-hidden leading-[0]">
                                    <div className="w-full h-full" style={{
                                        background: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 10' preserveAspectRatio='none'%3E%3Cpath d='M0,0 A10,10 0 0,0 20,0 L20,0 L0,0 Z' fill='rgba(251,113,133,0.95)'/%3E%3C/svg%3E") repeat-x`,
                                        backgroundSize: '20px 100%'
                                    }}></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 鍵アイコンの配置 (PC右下 / スマホ右上) に固定。GALLERY以外のページでも表示。 */}
                    {currentPage !== 'admin' && (
                        <button 
                            onClick={() => changePage('admin')} 
                            className={`fixed z-[100] w-9 h-9 flex items-center justify-center bg-white/60 backdrop-blur-md rounded-full shadow-md text-slate-300 hover:text-sky-500 transition-all border border-slate-100 right-3 sm:top-auto sm:bottom-6 sm:right-6 hover:scale-105 active:scale-95 ${isAnySaleActive ? 'top-14' : 'top-3'}`}
                        >
                            <Icon name="lock" size={15} />
                        </button>
                    )}

                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] w-[92%] max-w-sm glass rounded-full p-2 flex justify-around items-center transition-all duration-300">
                        {NAV_ITEMS.map(item => (
                            <button key={item.id} onClick={() => changePage(item.id)} className={`p-4 rounded-full transition-all duration-300 ${currentPage === item.id ? 'nav-active' : 'text-slate-400 hover:text-sky-400'}`}>
                                <Icon name={item.icon} size={22} />
                            </button>
                        ))}
                    </nav>

                    <main className="min-h-screen relative z-10 pb-32">
                        {currentPage === 'home' && (
                            <div className="fade-in-up">
                                <section className="relative overflow-hidden pt-28 md:pt-40 flex flex-col items-center">
                                    <div className="px-4 text-center w-full max-w-4xl relative z-10 mb-12">
                                        <div className="w-40 h-40 md:w-60 md:h-60 mx-auto mb-10 flex items-center justify-center text-sky-400/80">
                                            <Icon name="fish" className="w-full h-full" />
                                        </div>
                                        <h1 className="text-5xl md:text-7xl font-black text-white text-shadow tracking-tighter mb-4 italic uppercase leading-none">Medaka Village</h1>
                                        <p className="text-sky-900/40 font-bold tracking-[0.4em] text-[10px] uppercase mb-12 italic">Illustration Portfolio</p>
                                        <div className="flex flex-row justify-center gap-3 px-2 max-w-[420px] mx-auto">
                                            <button onClick={() => changePage('portfolio')} className="flex-1 py-4 bg-white border border-sky-100 text-sky-600 rounded-full font-bold text-[11px] shadow-sm hover:bg-sky-50 hover:shadow-md hover:-translate-y-0.5 transition-all uppercase tracking-widest whitespace-nowrap">View Gallery</button>
                                            <button onClick={() => changePage('menu')} className="flex-1 py-4 bg-sky-500 text-white rounded-full font-bold text-[11px] shadow-md shadow-sky-600/30 hover:bg-sky-400 hover:shadow-lg hover:shadow-sky-600/40 hover:-translate-y-0.5 transition-all uppercase tracking-widest whitespace-nowrap">View Menu</button>
                                        </div>
                                    </div>
                                    <WaveDivider className="relative w-full -mb-1" />
                                </section>
                                
                                <section className="pt-12 pb-20 relative z-30" style={{background: 'linear-gradient(to bottom, #f0f9ff 70%, transparent 100%)'}}>
                                    <div className="max-w-6xl mx-auto px-4 text-center overflow-visible">
                                        <h2 className="text-2xl font-black text-sky-900/80 italic uppercase mb-8 underline decoration-sky-200 decoration-4 underline-offset-4">Gallery</h2>
                                        
                                        <div className="w-screen relative left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] mb-4">
                                            <AutoScrollCarousel items={displayWorks} />
                                        </div>

                                        <div className="max-w-xl mx-auto mb-16 w-full flex justify-end px-4 md:px-0">
                                            <button onClick={() => changePage('portfolio')} className="text-sky-500 font-bold text-[10px] hover:underline italic underline-offset-4 tracking-widest uppercase">View Full Gallery →</button>
                                        </div>

                                        <h2 className="text-2xl font-black text-sky-900/80 italic uppercase mb-12 underline decoration-sky-200 decoration-4 underline-offset-4">Menu</h2>
                                        
                                        <div className="max-w-xl mx-auto mb-6 text-left">
                                            <PriceAccordion openMenuId={openMenuId} setOpenMenuId={setOpenMenuId} dynamicCategories={dynamicCategories} portfolio={portfolio} setSelectedWork={setSelectedWork} setWorkImgIndex={setWorkImgIndex} changePage={changePage} setFilterCategory={setFilterCategory} />
                                        </div>
                                        
                                        <div className="max-w-xl mx-auto w-full flex flex-col items-center gap-8 px-4 md:px-0">
                                            <div className="w-full flex justify-end">
                                                <button onClick={() => changePage('menu')} className="text-sky-500 font-bold text-[10px] hover:underline italic underline-offset-4 tracking-widest uppercase">View Full Menu →</button>
                                            </div>
                                            <button onClick={() => changePage('contact')} className="w-full max-w-[400px] bg-sky-500 text-white py-5 rounded-full font-bold text-[11px] shadow-md shadow-sky-600/30 hover:bg-sky-400 hover:shadow-lg hover:shadow-sky-600/40 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3 uppercase tracking-widest whitespace-nowrap active:scale-95">
                                                <Icon name="send" size={16} /> ご依頼・お見積りはこちら
                                            </button>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        )}

                        {currentPage !== 'home' && (
                            <div key={currentPage} className="fade-in-up">
                                <section className="pt-24 px-6 max-w-6xl mx-auto text-center relative z-30 min-h-[60vh]">
                                    
                                    {currentPage === 'portfolio' && (
                                        <>
                                            <h2 className="text-4xl font-black text-sky-900/80 mb-8 italic uppercase underline decoration-sky-100 decoration-8 underline-offset-[-2px]">Gallery</h2>
                                            
                                            <div className="flex gap-2 overflow-x-auto pt-1 pb-4 mb-8 no-scrollbar justify-start md:justify-center px-2">
                                                {categoryTabs.map(cat => (
                                                    <button 
                                                        key={cat}
                                                        onClick={() => setFilterCategory(cat)}
                                                        className={`px-6 py-2.5 rounded-full text-[11px] font-bold uppercase tracking-widest whitespace-nowrap transition-all flex-shrink-0 hover:-translate-y-0.5 ${
                                                            filterCategory === cat 
                                                            ? 'bg-sky-500 text-white shadow-md shadow-sky-600/30' 
                                                            : 'bg-white text-slate-500 shadow-sm border border-slate-100 hover:shadow-md hover:text-sky-600'
                                                        }`}
                                                    >
                                                        {cat === 'ALL' ? 'ALL' : cat}
                                                    </button>
                                                ))}
                                            </div>

                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 min-h-[200px]">
                                                {filteredWorks.length === 0 ? (
                                                    <div className="col-span-full text-slate-400 text-sm py-10">該当する作品はありません</div>
                                                ) : (
                                                    filteredWorks.map(w => (
                                                        <div key={w.id} className="aspect-square bg-white rounded-3xl overflow-hidden shadow-sm border border-sky-50 hover:shadow-xl transition-all cursor-pointer group relative shadow-sky-100/50" onClick={() => {setSelectedWork(w); setWorkImgIndex(0);}}>
                                                            <SmartThumbnail 
                                                                src={w.media && w.media.length > 0 ? (w.media[0].type === 'image' ? w.media[0].url : getYouTubeThumbnail(w.media[0].url)) : ''}
                                                                position={w.thumbnailPosition}
                                                                className="w-full h-full group-hover:scale-105 transition-transform duration-500"
                                                            />
                                                            <div className="absolute inset-0 bg-sky-900/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-[10px] font-bold uppercase tracking-widest backdrop-blur-[2px]">View</div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </>
                                    )}

                                    {currentPage === 'menu' && (
                                        <div className="max-w-xl mx-auto pb-24">
                                            <h2 className="text-4xl font-black text-sky-900/80 mb-16 italic uppercase underline decoration-sky-100 decoration-8 underline-offset-[-2px]">Menu</h2>
                                            
                                            <div className="mb-6">
                                                <PriceAccordion openMenuId={openMenuId} setOpenMenuId={setOpenMenuId} dynamicCategories={dynamicCategories} portfolio={portfolio} setSelectedWork={setSelectedWork} setWorkImgIndex={setWorkImgIndex} changePage={changePage} setFilterCategory={setFilterCategory} />
                                            </div>
                                            
                                            <div className="mb-8 flex justify-center">
                                                <button onClick={() => changePage('contact')} className="w-full max-w-[400px] bg-sky-500 text-white py-5 rounded-full font-bold text-[11px] shadow-md shadow-sky-600/30 hover:bg-sky-400 hover:shadow-lg hover:shadow-sky-600/40 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3 uppercase tracking-widest whitespace-nowrap active:scale-95">
                                                    <Icon name="send" size={16} className="mr-2" />ご依頼・お見積りはこちら
                                                </button>
                                            </div>

                                            <div className="space-y-8">
                                                <div className="bg-white/70 border border-slate-100 rounded-3xl p-8 text-left shadow-sm">
                                                    <h3 className="text-lg font-black text-slate-700 mb-6 flex items-center gap-2">
                                                        <span className="text-sky-500"><Icon name="alert" size={20} /></span>
                                                        ご依頼ガイドライン
                                                    </h3>
                                                    <div className="space-y-6 text-xs text-slate-600 font-medium">
                                                        <div><span className="font-bold inline-block mb-1 text-slate-700">権利について</span><p className="leading-relaxed pl-3 border-l-2 border-slate-200">著作権の譲渡は行っておりません（必要な場合は別途ご相談ください）。<br/>自作発言、二次配布、無断での商用利用、AI学習への使用は一切禁止です。</p></div>
                                                        <div><span className="font-bold inline-block mb-1 text-slate-700">加工・加筆について</span><p className="leading-relaxed pl-3 border-l-2 border-slate-200">原形を留めない過度な加工はご遠慮ください。<br/>サイズ調整、トリミング、背景の透過処理などの軽微な編集は自由です。</p></div>
                                                        <div><span className="font-bold inline-block mb-1 text-slate-700">商用利用について</span><p className="leading-relaxed pl-3 border-l-2 border-slate-200">合計金額の <span className="font-bold text-sky-600">＋50%</span> を頂戴いたします。<br/>対象：YouTube収益化済みの配信・動画利用（ショート含む）、グッズ販売、広告利用、その他利益が発生する活動。<br/>使用用途が商用利用にあたるかご不安な場合は、お気軽にご相談ください。</p></div>
                                                        <div><span className="font-bold inline-block mb-1 text-slate-700">実績公開について</span><p className="leading-relaxed pl-3 border-l-2 border-slate-200">制作物はポートフォリオやSNSに実績として掲載する場合がございます。<br/>非公開をご希望の場合は、<span className="font-bold text-sky-600">追加料金（＋¥5,000）</span>にて承ります。</p></div>
                                                        <div><span className="font-bold inline-block mb-1 text-slate-700">禁止事項</span><p className="leading-relaxed pl-3 border-l-2 border-slate-200">公序良俗に反する内容、政治・宗教・誹謗中傷に関わる用途での使用。</p></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {currentPage === 'profile' && (
                                        <div className="max-w-4xl mx-auto pb-24 text-center flex flex-col items-center">
                                            <h2 className="text-4xl font-black text-sky-900/80 mb-12 italic uppercase tracking-tighter w-full">Profile</h2>
                                            
                                            <div className="w-full max-w-[680px] glass rounded-[3rem] p-6 md:p-10 shadow-sm border border-white relative overflow-hidden mb-12">
                                                
                                                <div className="max-w-xl mx-auto relative z-10">
                                                    <div className="flex flex-col md:flex-row gap-8 items-center">
                                                        
                                                        <div className="flex flex-col items-center gap-4 w-full md:w-48 shrink-0">
                                                            <div className="flex flex-col items-center gap-3">
                                                                <div className="w-24 h-24 bg-sky-50 rounded-[2rem] flex items-center justify-center shadow-inner border border-sky-100 rotate-3 overflow-hidden shrink-0">
                                                                    <img src={profileIconUrl} alt="Medaka" className="w-full h-full object-cover" />
                                                                </div>
                                                                <div className="text-center">
                                                                    <h3 className="text-2xl font-black text-slate-800 tracking-tight">めだか</h3>
                                                                    <p className="text-[10px] text-sky-500 font-bold mt-1 uppercase tracking-widest">Medaka / Illustrator</p>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="w-full grid grid-cols-2 gap-2 mt-2">
                                                                <a href="https://x.com/medapappa" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-1.5 text-[11px] font-bold text-sky-600 bg-white border border-sky-100 shadow-sm py-2.5 rounded-full hover:bg-sky-50 hover:shadow-md hover:-translate-y-0.5 transition-all">
                                                                    <Icon name="twitter" size={14} /> <span className="text-center">Main</span>
                                                                </a>
                                                                <a href="https://skeb.jp/@medapappa" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-1.5 text-[11px] font-bold text-sky-600 bg-white border border-sky-100 shadow-sm py-2.5 rounded-full hover:bg-sky-50 hover:shadow-md hover:-translate-y-0.5 transition-all">
                                                                    <Icon name="sketchbook" size={14} /> <span className="text-center">Skeb</span>
                                                                </a>
                                                                <a href="https://www.pixiv.net/users/12054724" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-1.5 text-[11px] font-bold text-sky-600 bg-white border border-sky-100 shadow-sm py-2.5 rounded-full hover:bg-sky-50 hover:shadow-md hover:-translate-y-0.5 transition-all">
                                                                    <Icon name="pixiv" size={14} /> <span className="text-center">Pixiv</span>
                                                                </a>
                                                                <a href="https://www.youtube.com/channel/UCbtPE2WMeHvO2bu-gt3FDHA" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-1.5 text-[11px] font-bold text-sky-600 bg-white border border-sky-100 shadow-sm py-2.5 rounded-full hover:bg-sky-50 hover:shadow-md hover:-translate-y-0.5 transition-all">
                                                                    <Icon name="play" size={14} /> <span className="text-center">FPA</span>
                                                                </a>
                                                            </div>
                                                        </div>

                                                        <div className="flex-1 text-slate-600 leading-loose space-y-5 text-[13px] text-left">
                                                            <p>体温を感じるような色彩で描く、そこに実在するかのような空気感のあるキャラクターデザインが得意です。</p>
                                                            <p>5人組ゲーム実況チームの専属イラストレーターとして、動画サムネイルやOBS用配信画面の制作など、運営サポートも担当しています。競技性の高いゲームタイトルから最新のトレンドゲーム、ホラーゲームまで幅広い配信文化への造詣が深いため、実況者・VTuber様の配信映えする画面づくりをご提案可能です。</p>
                                                        </div>

                                                    </div>
                                                </div>

                                                <div className="mt-6 relative z-10 w-full">
                                                    <button 
                                                        onClick={() => setIsProfileExpanded(!isProfileExpanded)}
                                                        className="mx-auto flex items-center justify-center gap-2 w-full max-w-[280px] bg-sky-500 text-white py-4 rounded-full font-bold text-[11px] shadow-md shadow-sky-600/30 hover:bg-sky-400 hover:shadow-lg hover:shadow-sky-600/40 hover:-translate-y-0.5 transition-all uppercase tracking-widest whitespace-nowrap active:scale-95"
                                                    >
                                                        {isProfileExpanded ? 'Close Details' : 'View Details'} <Icon name="chevronDown" size={16} className={`transition-transform duration-300 ${isProfileExpanded ? 'rotate-180' : ''}`} />
                                                    </button>

                                                    <div className={`transition-all duration-700 ease-in-out overflow-hidden ${isProfileExpanded ? 'max-h-[2000px] opacity-100 mt-8' : 'max-h-0 opacity-0'}`}>
                                                        <div className="bg-white/70 p-6 md:p-8 rounded-[2rem] border border-sky-100 space-y-8 text-xs text-slate-600 font-medium shadow-sm text-left max-w-2xl mx-auto w-full">
                                                            
                                                            <div>
                                                                <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2 text-[13px]"><Icon name="edit" size={16} className="text-sky-400"/> WORKS</h4>
                                                                <ul className="space-y-3 pl-3 border-l-2 border-slate-200 leading-relaxed list-none">
                                                                    <li>2017年より個人・企業様問わずイラスト制作案件を受注。</li>
                                                                    <li>商業公式コラボカフェ等のグッズデザイン（ポージング提案・イラスト制作等）</li>
                                                                    <li>商業アンソロジー参加、漫画アシスタント（背景・トーン）、Webtoon着彩業務</li>
                                                                    <li>長年の事務職経験があり、こまめな報連相やスケジュール管理、コツコツとした丁寧な作業を得意としております。</li>
                                                                </ul>
                                                            </div>

                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <div className="bg-sky-50/50 p-4 rounded-2xl border border-sky-100 flex flex-col items-center justify-center text-center">
                                                                    <h4 className="text-[10px] font-black text-sky-500 uppercase tracking-widest mb-2">使用ツール</h4>
                                                                    <p className="text-[11px] font-bold text-sky-800 leading-relaxed">ClipStudio EX<br/>Photoshop / Illustrator</p>
                                                                </div>
                                                                <div className="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 flex flex-col items-center justify-center text-center">
                                                                    <h4 className="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-2">学習中</h4>
                                                                    <p className="text-[11px] font-bold text-indigo-800 leading-relaxed">Live2D<br/>Webtoon / Manga</p>
                                                                </div>
                                                            </div>

                                                            <div>
                                                                <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2 text-[13px]"><Icon name="star" size={16} className="text-yellow-400"/> ABOUT ME</h4>
                                                                <p className="pl-3 border-l-2 border-slate-200 leading-relaxed mb-4">
                                                                    トレンドを意識したやわらかい色合いや、女の子を描くことが大好きです。ご要望に合わせて、主線なしの絵本風イラストや彩度の高いアニメ塗りなど、柔軟な表現も可能です。現在はLive2Dモデリングも学習中で、将来的な表現領域の拡大を目指しています。
                                                                </p>
                                                                <div className="bg-slate-50/80 p-5 rounded-2xl border border-slate-100">
                                                                    <ul className="space-y-3 leading-relaxed">
                                                                        <li className="flex items-start gap-3"><span className="font-bold text-slate-500 w-14 shrink-0 text-right text-[11px] mt-0.5">好きな色</span><span className="text-slate-700">水色</span></li>
                                                                        <li className="flex items-start gap-3"><span className="font-bold text-slate-500 w-14 shrink-0 text-right text-[11px] mt-0.5">ゲーム</span><span className="text-slate-700">Valorant / LoL / ゼルダの伝説 / トレンド・ホラーなど幅広く</span></li>
                                                                        <li className="flex items-start gap-3"><span className="font-bold text-slate-500 w-14 shrink-0 text-right text-[11px] mt-0.5">カルチャー</span><span className="text-slate-700">配信・実況動画の視聴 / マンガ / アニメ / 映画</span></li>
                                                                    </ul>
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="mt-8 relative z-10 w-full">
                                                    <h3 className="text-[10px] font-black text-slate-400 mb-6 uppercase tracking-widest flex items-center justify-center gap-3">
                                                        <span className="w-8 h-[1px] bg-slate-200"></span>
                                                        Other Links
                                                        <span className="w-8 h-[1px] bg-slate-200"></span>
                                                    </h3>
                                                    <div className="flex flex-wrap justify-center gap-3 max-w-lg mx-auto px-4">
                                                        {SOCIAL_LINKS.map((link, i) => (
                                                            <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-[11px] font-bold text-sky-600 bg-white border border-sky-100 shadow-sm hover:bg-sky-50 hover:shadow-md hover:-translate-y-0.5 px-5 py-2.5 rounded-full transition-all">
                                                                <Icon name={link.icon} size={14} />
                                                                <span>{link.name}</span>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    )}

                                    {currentPage === 'contact' && (
                                        <div className="max-w-xl mx-auto">
                                            <h2 className="text-4xl font-black text-sky-900/80 mb-12 italic uppercase tracking-tighter">Contact</h2>
                                            
                                            <div className="glass rounded-[3rem] p-8 md:p-12 shadow-sm border border-white relative overflow-hidden text-center flex flex-col gap-4">
                                                
                                                <div className="inline-flex flex-col items-center bg-white border-2 border-dashed border-sky-200/80 px-10 py-6 rounded-3xl shadow-sm mx-auto relative mt-3">
                                                    <div className="absolute -top-3.5 bg-sky-100 text-sky-600 font-black text-[10px] px-4 py-1 rounded-full tracking-widest flex items-center gap-1 shadow-sm">
                                                        <Icon name="check" size={12} /> STATUS
                                                    </div>
                                                    <p className="text-[13px] font-bold text-slate-600 leading-loose">
                                                        現在、<br className="block md:hidden"/>
                                                        {/* Firestoreからの設定値を反映 */}
                                                        <span className="text-sky-500 text-[17px] mx-1 font-black">{siteSettings.acceptStatus}</span>
                                                        <br className="block md:hidden"/>
                                                        着手の案件を受付中です。
                                                    </p>
                                                </div>
                                                
                                                <div className="flex flex-col items-center gap-3 w-full max-w-[500px] mx-auto">
                                                    <p className="text-[13px] text-slate-500 font-medium leading-relaxed">ご依頼、お見積りのご相談は下記よりお気軽にご連絡ください。</p>
                                                    
                                                    <div className="flex flex-col sm:flex-row justify-center gap-3 w-full relative">
                                                        <div className="flex-1 min-w-0">
                                                            <button onClick={handleEmailCopy} className="group flex items-center justify-center w-full bg-sky-500 text-white py-4 rounded-full font-bold text-[11px] shadow-md shadow-sky-600/30 hover:bg-sky-400 hover:shadow-lg hover:shadow-sky-600/40 hover:-translate-y-0.5 transition-all tracking-widest whitespace-nowrap">
                                                                <div className="flex items-center gap-2">
                                                                    <Icon name="mail" size={14} />
                                                                    <span>メール</span>
                                                                </div>
                                                            </button>
                                                        </div>
                                                        
                                                        <div className="flex-1 min-w-0">
                                                            <a href="https://twitter.com/medapappa" target="_blank" rel="noopener noreferrer" className="group flex items-center justify-center w-full bg-slate-800 text-white py-4 rounded-full font-bold text-[11px] shadow-md shadow-slate-900/30 hover:bg-slate-700 hover:shadow-lg hover:shadow-slate-900/40 hover:-translate-y-0.5 transition-all tracking-widest whitespace-nowrap">
                                                                <div className="flex items-center gap-2">
                                                                    <Icon name="twitter" size={14} />
                                                                    <span>X (Twitter)</span>
                                                                </div>
                                                            </a>
                                                        </div>

                                                        <div className="flex-1 min-w-0">
                                                            <a href="https://skeb.jp/@medapappa" target="_blank" rel="noopener noreferrer" className="group flex items-center justify-center w-full bg-teal-500 text-white py-4 rounded-full font-bold text-[11px] shadow-md shadow-teal-600/30 hover:bg-teal-400 hover:shadow-lg hover:shadow-teal-600/40 hover:-translate-y-0.5 transition-all tracking-widest whitespace-nowrap">
                                                                <div className="flex items-center gap-2">
                                                                    <Icon name="sketchbook" size={14} />
                                                                    <span>Skeb</span>
                                                                </div>
                                                            </a>
                                                        </div>
                                                    </div>
                                                    {emailCopied && <div className="text-sky-500 text-[10px] font-bold animate-pulse fade-in-up -mt-1">メールアドレスをコピーしました。</div>}
                                                </div>

                                                <div className="border-t border-sky-100/50 pt-4 text-left w-full">
                                                    <h3 className="text-sm font-black text-slate-700 mb-4 flex items-center gap-2 justify-center md:justify-start"><Icon name="mail" size={16} className="text-sky-500"/> お申し込み用テンプレート</h3>
                                                    <div className="bg-white/80 rounded-2xl border border-sky-50 p-5 text-xs text-slate-600 font-mono leading-loose relative shadow-inner h-48 overflow-y-auto custom-scrollbar">
                                                        <pre className="whitespace-pre-wrap">{TEMPLATE_TEXT}</pre>
                                                        <button onClick={() => handleTemplateCopy(TEMPLATE_TEXT)} className={`absolute top-3 right-3 flex items-center gap-2 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all ${copied ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-sky-100 hover:text-sky-600'}`}>{copied ? <>Copied! <Icon name="check" size={12} /></> : <>Copy <Icon name="copy" size={12} /></>}</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </section>
                            </div>
                        )}
                    </main>

                    {/* --- 作品詳細モーダル --- */}
                    {selectedWork && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 transition-all duration-300" onClick={() => setSelectedWork(null)}>
                            <div className="absolute inset-0 bg-white/80 backdrop-blur-md"></div>
                            <div className="bg-white w-full max-w-5xl rounded-[2.5rem] shadow-2xl overflow-y-auto max-h-[90vh] relative z-10 animate-fade-up border border-white" 
                                onTouchStart={handleTouchStart} 
                                onTouchEnd={handleTouchEnd}
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="sticky top-0 right-0 z-50 flex justify-end p-4 pb-0 pointer-events-none">
                                    <button onClick={() => setSelectedWork(null)} className="pointer-events-auto w-10 h-10 bg-slate-100/90 backdrop-blur hover:bg-slate-200 text-slate-400 hover:text-slate-800 rounded-full flex items-center justify-center transition-colors shadow-sm">
                                        <Icon name="x" size={20} />
                                    </button>
                                </div>
                                
                                <div className="flex flex-col md:flex-row gap-8 md:gap-12 p-6 md:p-10 pt-0 -mt-2">
                                    <div className="flex-1 space-y-4">
                                        <div className="relative w-full rounded-2xl overflow-hidden bg-slate-50 border border-slate-100 shadow-md group">
                                            {selectedWork.media && selectedWork.media.length > 0 && selectedWork.media[workImgIndex] ? (
                                                selectedWork.media[workImgIndex].type === 'video' ? (
                                                    <video src={selectedWork.media[workImgIndex].url} controls className="w-full h-auto" />
                                                ) : selectedWork.media[workImgIndex].type === 'youtube' ? (
                                                    <iframe src={getYouTubeEmbedUrl(selectedWork.media[workImgIndex].url)} className="w-full aspect-video" frameBorder="0" allow="autoplay; encrypted-media; picture-in-picture" allowFullScreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
                                                ) : (
                                                    <img src={selectedWork.media[workImgIndex].url} className="w-full h-auto cursor-zoom-in" onClick={() => setFullScreenUrl(selectedWork.media[workImgIndex].url)} alt={selectedWork.title} />
                                                )
                                            ) : (
                                                <img src={selectedWork.urls && selectedWork.urls.length > 0 ? selectedWork.urls[workImgIndex] : ''} className="w-full h-auto cursor-zoom-in" onClick={() => setFullScreenUrl(selectedWork.urls ? selectedWork.urls[workImgIndex] : '')} alt={selectedWork.title} />
                                            )}
                                            
                                            {((selectedWork.media && selectedWork.media.length > 1) || (selectedWork.urls && selectedWork.urls.length > 1)) && (
                                                <>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); setWorkImgIndex((prev) => (prev - 1 + (selectedWork.media || selectedWork.urls).length) % (selectedWork.media || selectedWork.urls).length); }} 
                                                        className="absolute top-1/2 left-4 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 bg-white/80 hover:bg-white text-slate-700 rounded-full flex items-center justify-center transition-all shadow-lg z-50"
                                                    >
                                                        <Icon name="chevronLeft" size={28}/>
                                                    </button>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); setWorkImgIndex((prev) => (prev + 1) % (selectedWork.media || selectedWork.urls).length); }} 
                                                        className="absolute top-1/2 right-4 -translate-y-1/2 w-10 h-10 md:w-12 md:h-12 bg-white/80 hover:bg-white text-slate-700 rounded-full flex items-center justify-center transition-all shadow-lg z-50"
                                                    >
                                                        <Icon name="chevronLeft" size={28} className="rotate-180"/>
                                                    </button>
                                                </>
                                            )}

                                            {((selectedWork.media && selectedWork.media.length > 1) || (selectedWork.urls && selectedWork.urls.length > 1)) && (
                                                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                                                    {(selectedWork.media || selectedWork.urls).map((_, i) => (
                                                        <button key={i} onClick={(e) => { e.stopPropagation(); setWorkImgIndex(i); }} className={`w-2 h-2 rounded-full transition-all shadow-sm ${workImgIndex === i ? 'bg-sky-500 w-4' : 'bg-white/80 hover:bg-white'}`} />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div className="w-full md:w-[320px] text-left flex flex-col gap-4">
                                        <div className="flex flex-col gap-3">
                                            <div>
                                                <h3 className="text-xl md:text-2xl font-black text-slate-800 mb-2 leading-tight">{selectedWork.title}</h3>
                                                <div className="flex flex-wrap gap-1.5">
                                                    <span className="text-[10px] text-white font-bold uppercase tracking-widest bg-sky-400 px-3 py-1 rounded-full">{selectedWork.category && selectedWork.category.replace('■ ', '')}</span>
                                                    {selectedWork.tags && selectedWork.tags.map((tag, i) => (
                                                        <span key={i} className="text-[10px] text-slate-500 font-bold bg-slate-100 px-2 py-1 rounded-full border border-slate-200">{tag}</span>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            <div className="bg-sky-50 px-5 py-3 rounded-full flex items-center justify-between border border-sky-100 shadow-sm mt-1">
                                                <span className="text-[10px] font-bold text-sky-500 uppercase tracking-widest flex items-center gap-2"><Icon name="clock" size={14}/> Time</span>
                                                <span className="text-sm font-black text-sky-700">{selectedWork.time || '10h'}</span>
                                            </div>
                                            
                                            <div className="bg-indigo-50/50 px-5 py-4 rounded-[1.5rem] border border-indigo-100 relative overflow-hidden flex-1">
                                                <h4 className="text-[10px] font-black text-indigo-500 uppercase mb-2 tracking-widest flex items-center gap-1.5">
                                                    <Icon name="pencil" size={14} className="text-indigo-400" /> Focus Point
                                                </h4>
                                                <p className="text-indigo-900 font-medium text-xs leading-loose whitespace-pre-wrap">{selectedWork.focus}</p>
                                            </div>
                                        </div>
                                        
                                        <div className="pt-2">
                                            <button onClick={() => {setSelectedWork(null); changePage('contact');}} className="w-full bg-sky-500 text-white py-4 rounded-full font-bold text-[11px] shadow-md shadow-sky-600/30 hover:bg-sky-400 hover:shadow-lg hover:shadow-sky-600/40 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3 uppercase tracking-widest whitespace-nowrap active:scale-95">
                                                <Icon name="send" size={16} /> ご依頼・お見積りはこちら
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Full Screen */}
                    {fullScreenUrl && (
                        <div className="fixed inset-0 z-[300] bg-white/95 backdrop-blur-xl flex items-center justify-center p-4 cursor-zoom-out animate-fade-in" onClick={() => setFullScreenUrl(null)}>
                            <img src={fullScreenUrl} className="max-w-full max-h-full object-contain drop-shadow-2xl rounded-lg pointer-events-none" />
                            <button className="absolute top-6 right-6 p-4 bg-slate-100 rounded-full hover:bg-slate-200 transition-all"><Icon name="x" size={24} /></button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        document.addEventListener('contextmenu', (e) => {
            if (e.target.tagName === 'IMG') e.preventDefault();
        });
    </script>
</body>
</html>